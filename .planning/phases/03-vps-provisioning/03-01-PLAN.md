---
phase: 03-vps-provisioning
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - drizzle/0003_add_vps_fields.sql
  - src/lib/provisioning/types.ts
  - src/lib/provisioning/ssh-keys.ts
autonomous: true

must_haves:
  truths:
    - "Database tracks Hetzner server ID for each user's VPS"
    - "Database tracks VPS IP address and provisioning status"
    - "System can generate SSH key pairs for VPS access"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "VPS tracking fields in subscriptions table"
      contains: "hetznerServerId, vpsIpAddress, provisioningStatus"
    - path: "drizzle/0003_add_vps_fields.sql"
      provides: "Database migration for VPS fields"
      min_lines: 10
    - path: "src/lib/provisioning/types.ts"
      provides: "TypeScript types for Hetzner API and provisioning"
      exports: ["HetznerServerResponse", "ProvisioningStatus", "CloudInitConfig"]
    - path: "src/lib/provisioning/ssh-keys.ts"
      provides: "SSH key generation utilities"
      exports: ["generateSSHKeyPair"]
  key_links:
    - from: "src/lib/provisioning/ssh-keys.ts"
      to: "node:crypto"
      via: "generateKeyPairSync"
      pattern: "generateKeyPairSync.*rsa"
---

<objective>
Extend database schema to track VPS server details and implement SSH key generation for secure VPS access.

Purpose: Enable Rachel Cloud to track provisioned VPS instances and generate SSH credentials for automation.
Output: Database schema with VPS fields, migration applied, SSH key generation utility, TypeScript types for Hetzner API.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-vps-provisioning/03-CONTEXT.md
@.planning/phases/03-vps-provisioning/03-RESEARCH.md
@src/lib/db/schema.ts
@src/lib/crypto/encryption.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Extend database schema with VPS tracking fields</name>
  <files>
src/lib/db/schema.ts
drizzle/0003_add_vps_fields.sql
  </files>
  <action>
Add VPS tracking fields to the subscriptions table in schema.ts:
- hetznerServerId: integer (nullable) - Hetzner server ID from API
- hetznerSshKeyId: integer (nullable) - Hetzner SSH key ID from API
- vpsIpAddress: text (nullable) - Public IPv4 address of VPS
- vpsHostname: text (nullable) - Hostname assigned to VPS
- provisioningStatus: text enum (nullable) - 'pending' | 'creating' | 'cloud_init' | 'injecting_secrets' | 'ready' | 'failed'
- provisioningError: text (nullable) - Error message if provisioning fails
- provisionedAt: integer timestamp (nullable) - When VPS provisioning completed
- deprovisionedAt: integer timestamp (nullable) - When VPS was destroyed
- sshPrivateKey: text (nullable) - Encrypted SSH private key for VPS access (store encrypted using encryptToken from crypto/encryption.ts)

Generate migration using `bun run drizzle-kit generate` and verify migration file created in drizzle/ directory.

Push migration to database using `bun run drizzle-kit push`.
  </action>
  <verify>
Migration file exists at drizzle/0003_add_vps_fields.sql
Run `bun run drizzle-kit push` successfully
Query subscriptions table schema shows new VPS fields
  </verify>
  <done>
Database schema includes all VPS tracking fields, migration applied successfully, subscriptions table ready for VPS provisioning data
  </done>
</task>

<task type="auto">
  <name>Create Hetzner API TypeScript types</name>
  <files>
src/lib/provisioning/types.ts
  </files>
  <action>
Create comprehensive TypeScript types for Hetzner Cloud API interactions based on research findings (03-RESEARCH.md):

1. Request types:
   - CreateServerRequest (name, server_type, image, location, ssh_keys, user_data, firewalls, start_after_create, public_net)
   - CreateSSHKeyRequest (name, public_key)
   - CreateFirewallRequest (name, rules)

2. Response types:
   - HetznerServerResponse (server object with id, name, status, public_net.ipv4.ip, created)
   - HetznerActionResponse (action object with id, command, status, progress, started, finished, error)
   - HetznerSSHKeyResponse (ssh_key object with id, name, public_key)
   - HetznerFirewallResponse (firewall object with id, name, rules)

3. Status enums:
   - ServerStatus: 'initializing' | 'starting' | 'running' | 'stopping' | 'off' | 'deleting' | 'rebuilding' | 'migrating' | 'unknown'
   - ActionStatus: 'running' | 'success' | 'error'
   - ProvisioningStatus: 'pending' | 'creating' | 'cloud_init' | 'injecting_secrets' | 'ready' | 'failed'

4. Config types:
   - CloudInitConfig (username, sshPublicKey, callbackUrl)
   - SSHInjectionConfig (host, username, privateKey, claudeAccessToken, claudeRefreshToken, claudeExpiresAt, telegramBotToken, ownerTelegramUserId)

Use exact field names from Hetzner API docs (snake_case for API, camelCase for internal TypeScript).
  </action>
  <verify>
TypeScript compilation succeeds with no errors
All exported types are valid and match Hetzner API schema from research
  </verify>
  <done>
Complete TypeScript type definitions exist for all Hetzner API operations and provisioning configurations
  </done>
</task>

<task type="auto">
  <name>Implement SSH key generation utility</name>
  <files>
src/lib/provisioning/ssh-keys.ts
  </files>
  <action>
Create SSH key pair generation utility using Node.js crypto module:

1. Export `generateSSHKeyPair()` function that:
   - Uses crypto.generateKeyPairSync with 'rsa' algorithm, 4096-bit modulus
   - Exports public key in 'ssh-rsa' format (type: 'spki', format: 'pem')
   - Exports private key in PKCS8 PEM format (type: 'pkcs8', format: 'pem')
   - Returns { publicKey: string, privateKey: string }

2. Public key should be in OpenSSH format suitable for Hetzner SSH key upload and cloud-init authorized_keys
3. Private key should be in PEM format suitable for ssh2 library connections

Example usage:
```typescript
const { publicKey, privateKey } = await generateSSHKeyPair();
// publicKey: "ssh-rsa AAAAB3NzaC1yc2EA..."
// privateKey: "-----BEGIN PRIVATE KEY-----\nMIIJQg..."
```

No external dependencies - use only node:crypto built-in module.
  </action>
  <verify>
TypeScript compilation succeeds
Function generates valid RSA 4096-bit key pairs
Public key starts with "ssh-rsa AAAAB3NzaC1yc2EA"
Private key starts with "-----BEGIN PRIVATE KEY-----"
  </verify>
  <done>
SSH key generation utility successfully creates RSA key pairs in correct formats for Hetzner API and ssh2 library
  </done>
</task>

</tasks>

<verification>
1. Database migration applied successfully with all VPS tracking fields
2. TypeScript types compile without errors and match Hetzner API schema
3. SSH key generation produces valid key pairs in correct formats
4. All files follow existing code conventions from Phases 1-2
</verification>

<success_criteria>
1. Database schema extended with 9 new VPS tracking fields in subscriptions table
2. Migration file generated and applied to local SQLite database
3. Complete TypeScript types for Hetzner API requests/responses
4. SSH key generation utility creates valid 4096-bit RSA key pairs
5. All TypeScript compilation passes with strict mode
</success_criteria>

<output>
After completion, create `.planning/phases/03-vps-provisioning/03-01-SUMMARY.md`
</output>

