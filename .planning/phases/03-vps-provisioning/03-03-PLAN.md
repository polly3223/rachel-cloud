---
phase: 03-vps-provisioning
plan: 03
type: execute
wave: 2
depends_on: [03-01, 03-02]
files_modified:
  - src/lib/provisioning/cloud-init-builder.ts
  - src/lib/provisioning/ssh-injector.ts
  - src/routes/api/provision/callback/[userId]/+server.ts
  - package.json
autonomous: true

must_haves:
  truths:
    - "System generates cloud-init YAML under 32KiB limit"
    - "Cloud-init installs Bun, Git, Claude CLI, and clones Rachel8"
    - "Cloud-init POSTs completion callback to control plane"
    - "System injects secrets via SSH after cloud-init completes"
    - "Callback endpoint updates database when cloud-init finishes"
  artifacts:
    - path: "src/lib/provisioning/cloud-init-builder.ts"
      provides: "Cloud-init YAML generator"
      exports: ["buildCloudInitUserData"]
      min_lines: 80
    - path: "src/lib/provisioning/ssh-injector.ts"
      provides: "SSH secret injection utility"
      exports: ["injectSecrets"]
      min_lines: 100
    - path: "src/routes/api/provision/callback/[userId]/+server.ts"
      provides: "Cloud-init completion webhook endpoint"
      exports: ["POST"]
      min_lines: 30
    - path: "package.json"
      provides: "ssh2 and node-scp dependencies"
      contains: "ssh2"
  key_links:
    - from: "src/lib/provisioning/cloud-init-builder.ts"
      to: "/api/provision/callback/[userId]"
      via: "phone_home URL in cloud-config"
      pattern: "phone_home.*url.*callback"
    - from: "src/lib/provisioning/ssh-injector.ts"
      to: "ssh2.Client"
      via: "SSH connection and command execution"
      pattern: "new Client.*connect"
    - from: "src/routes/api/provision/callback/[userId]/+server.ts"
      to: "src/lib/db"
      via: "Update subscription provisioningStatus"
      pattern: "update.*subscriptions.*provisioningStatus"
---

<objective>
Build cloud-init infrastructure automation and SSH-based secret injection for secure VPS provisioning.

Purpose: Automate VPS setup (non-secret) via cloud-init and inject sensitive credentials securely via SSH after provisioning.
Output: Cloud-init builder, SSH secret injector, completion callback endpoint, ready for orchestration.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-vps-provisioning/03-CONTEXT.md
@.planning/phases/03-vps-provisioning/03-RESEARCH.md
@src/lib/db/schema.ts
@src/lib/crypto/encryption.ts
@package.json
</context>

<tasks>

<task type="auto">
  <name>Install SSH automation libraries</name>
  <files>
package.json
  </files>
  <action>
Add ssh2 library and TypeScript types for SSH automation:

Run: `bun add ssh2 node-scp`
Run: `bun add -d @types/ssh2`

These libraries enable SSH connections and file transfer for secret injection, as recommended in 03-RESEARCH.md.
  </action>
  <verify>
package.json includes "ssh2" and "node-scp" in dependencies
package.json includes "@types/ssh2" in devDependencies
`bun install` succeeds without errors
  </verify>
  <done>
SSH libraries installed and ready for secret injection implementation
  </done>
</task>

<task type="auto">
  <name>Implement cloud-init YAML builder</name>
  <files>
src/lib/provisioning/cloud-init-builder.ts
  </files>
  <action>
Create cloud-init user-data generator following Pattern 2 from 03-RESEARCH.md and locked decisions from 03-CONTEXT.md:

1. Export `buildCloudInitUserData(config: CloudInitConfig): string` that accepts:
   - username: 'rachel' (from CONTEXT.md decision)
   - sshPublicKey: SSH public key for authorized_keys
   - callbackUrl: Control plane callback URL for completion signal

2. Generate cloud-init YAML with:
   - users: rachel user with sudo NOPASSWD, bash shell, SSH authorized key
   - packages: git, curl, unzip
   - runcmd (in exact order):
     a. Install Bun: `curl -fsSL https://bun.sh/install | bash`
     b. Add Bun to PATH in .bashrc
     c. Install GitHub CLI: Add GPG key, apt repo, apt install gh
     d. Install Claude Code CLI: `curl -fsSL https://code.claude.com/install.sh | bash` (NOTE: verify this URL during execution)
     e. Clone Rachel8: `su - rachel -c 'git clone https://github.com/polly3223/Rachel8.git ~/rachel8'`
     f. Install dependencies: `su - rachel -c 'cd ~/rachel8 && ~/.bun/bin/bun install'`
     g. Create shared folder: `mkdir -p /home/rachel/shared && chown rachel:rachel /home/rachel/shared`
   - phone_home: POST to callbackUrl with instance_id and hostname when complete

3. Validate YAML size < 32KiB (Hetzner limit):
   - Calculate final YAML byte length
   - Throw error if > 30KB (safety margin)

4. Return as string starting with `#cloud-config\n` followed by YAML structure

CRITICAL: Do NOT include any secrets (Claude tokens, Telegram token) in cloud-init - these are injected via SSH in next task.

Use exact format from research code example but update for Rachel8 requirements.
  </action>
  <verify>
TypeScript compilation succeeds
Generated YAML is valid cloud-config format
YAML size validation prevents exceeding 32KiB limit
phone_home callback URL is correctly included
No secrets appear in generated YAML
  </verify>
  <done>
Cloud-init builder generates valid YAML under size limit, installs all required software, and triggers callback on completion
  </done>
</task>

<task type="auto">
  <name>Implement SSH secret injection and service startup</name>
  <files>
src/lib/provisioning/ssh-injector.ts
  </files>
  <action>
Create SSH-based secret injector following Pattern 3 from 03-RESEARCH.md:

1. Export `injectSecrets(config: SSHInjectionConfig): Promise<void>` that accepts:
   - host: VPS IP address
   - username: 'rachel'
   - privateKey: SSH private key (PEM format)
   - claudeAccessToken: Decrypted Claude access token
   - claudeRefreshToken: Decrypted Claude refresh token
   - claudeExpiresAt: Token expiry timestamp
   - telegramBotToken: Decrypted Telegram bot token
   - ownerTelegramUserId: User's Telegram ID

2. Use ssh2 Client to:
   a. Connect to VPS (30-second timeout)
   b. Create .claude directory: `mkdir -p /home/rachel/.claude`
   c. Write .credentials.json with Claude OAuth tokens:
      ```json
      {
        "claudeAiOauth": {
          "accessToken": "...",
          "refreshToken": "...",
          "expiresAt": 1234567890,
          "scopes": ["user:inference", "user:profile"]
        }
      }
      ```
   d. Set permissions: `chmod 600 /home/rachel/.claude/.credentials.json`
   e. Write .env file for Rachel8:
      ```
      TELEGRAM_BOT_TOKEN=...
      OWNER_TELEGRAM_USER_ID=...
      SHARED_FOLDER_PATH=/home/rachel/shared
      NODE_ENV=production
      LOG_LEVEL=info
      ```
   f. Set permissions: `chmod 600 /home/rachel/rachel8/.env`
   g. Copy rachel8.service template to systemd: `sudo cp ~/rachel8/rachel8.service /etc/systemd/system/`
   h. Enable service: `sudo systemctl daemon-reload && sudo systemctl enable rachel8`
   i. Start service: `sudo systemctl start rachel8`
   j. Verify service running: `sudo systemctl is-active rachel8` (expect "active")

3. Use execCommand helper (from research Pattern 3) to run commands and capture output/errors

4. Error handling:
   - Wrap all SSH operations in try/catch
   - If any step fails, throw descriptive error with step name
   - Include stderr output in error messages
   - Always close SSH connection in finally block

5. Service validation:
   - Check systemd status shows "active"
   - If not active, read journal logs: `journalctl -u rachel8 -n 50 --no-pager`
   - Include logs in error message

Use exact code structure from research but adapt for Rachel8 specifics.
  </action>
  <verify>
TypeScript compilation succeeds
SSH connection logic properly handles timeouts and errors
File writes use secure heredoc syntax to avoid escaping issues
Service validation confirms Rachel8 is running before returning
Error messages include step context and stderr output
  </verify>
  <done>
SSH injector successfully writes secrets to VPS, starts Rachel8 service, and validates it's running
  </done>
</task>

<task type="auto">
  <name>Create cloud-init completion callback endpoint</name>
  <files>
src/routes/api/provision/callback/[userId]/+server.ts
  </files>
  <action>
Create SvelteKit API endpoint to receive cloud-init completion signals:

1. Export POST handler that:
   - Accepts userId from URL params
   - Parses JSON body (instance_id, hostname from phone_home module)
   - Validates userId exists in database
   - Updates subscription record:
     - Set provisioningStatus = 'cloud_init' â†’ 'injecting_secrets'
     - Set vpsHostname from request body
     - Set updatedAt timestamp
   - Returns 200 OK on success, 404 if userId not found, 500 on database errors

2. Security:
   - No authentication required (cloud-init can't hold auth tokens)
   - Validate userId format (UUID)
   - Rate limit: accept only one callback per userId (idempotent)

3. Logging:
   - Log successful callbacks with userId and hostname
   - Log errors with full context for debugging

4. Database update using Drizzle:
   - Import db and subscriptions from $lib/db
   - Use eq() for where clause
   - Handle case where subscription doesn't exist

Example request from cloud-init:
```json
{
  "instance_id": "i-abc123",
  "hostname": "rachel-cloud-user123"
}
```

Use existing API route patterns from Phase 2 as reference.
  </action>
  <verify>
TypeScript compilation succeeds
Endpoint returns 200 for valid userId and updates database
Endpoint returns 404 for invalid userId
Database query uses proper Drizzle syntax
  </verify>
  <done>
Callback endpoint successfully receives cloud-init signals and updates provisioning status in database
  </done>
</task>

</tasks>

<verification>
1. Cloud-init YAML generates successfully and stays under 32KiB
2. SSH injection connects to VPS and writes all required files
3. Rachel8 service starts and systemd reports "active"
4. Callback endpoint updates database when cloud-init completes
5. No secrets appear in cloud-init user-data
</verification>

<success_criteria>
1. Cloud-init builder produces valid YAML with all software installations
2. SSH injector writes Claude credentials and Telegram token securely
3. systemd service validation confirms Rachel8 is running
4. Callback endpoint updates provisioning status on cloud-init completion
5. All operations use proper error handling and logging
</success_criteria>

<output>
After completion, create `.planning/phases/03-vps-provisioning/03-03-SUMMARY.md`
</output>
