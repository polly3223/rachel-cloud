---
phase: 03-vps-provisioning
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/provisioning/hetzner-client.ts
  - package.json
autonomous: true

user_setup:
  - service: hetzner
    why: "VPS provisioning via Hetzner Cloud API"
    env_vars:
      - name: HETZNER_API_TOKEN
        source: "Hetzner Cloud Console -> Security -> API tokens -> Generate API token (Read & Write permissions)"

must_haves:
  truths:
    - "System can create Hetzner VPS via API with retry logic"
    - "System can delete Hetzner VPS via API with error handling"
    - "System can poll Hetzner action status until completion"
    - "API client handles rate limits and transient errors automatically"
  artifacts:
    - path: "src/lib/provisioning/hetzner-client.ts"
      provides: "Hetzner Cloud API client with exponential backoff"
      exports: ["HetznerClient"]
      min_lines: 150
    - path: "package.json"
      provides: "exponential-backoff dependency"
      contains: "exponential-backoff"
  key_links:
    - from: "src/lib/provisioning/hetzner-client.ts"
      to: "exponential-backoff"
      via: "backOff function"
      pattern: "import.*backOff.*exponential-backoff"
    - from: "HetznerClient.createServer"
      to: "https://api.hetzner.cloud/v1/servers"
      via: "fetch with Authorization header"
      pattern: "fetch.*api\\.hetzner\\.cloud.*servers"
---

<objective>
Implement Hetzner Cloud API client with automatic retry logic, rate limit handling, and exponential backoff for reliable VPS provisioning.

Purpose: Provide a resilient API wrapper for all Hetzner operations needed in provisioning workflow.
Output: Production-ready Hetzner client that handles transient failures and API rate limits gracefully.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-vps-provisioning/03-CONTEXT.md
@.planning/phases/03-vps-provisioning/03-RESEARCH.md
@package.json
</context>

<tasks>

<task type="auto">
  <name>Install exponential-backoff library</name>
  <files>
package.json
  </files>
  <action>
Add exponential-backoff library for retry logic:

Run: `bun add exponential-backoff`

This library provides battle-tested exponential backoff implementation for resilient API calls, recommended in 03-RESEARCH.md.
  </action>
  <verify>
package.json includes "exponential-backoff" in dependencies
`bun install` succeeds without errors
  </verify>
  <done>
exponential-backoff library installed and ready for use in Hetzner client
  </done>
</task>

<task type="auto">
  <name>Implement Hetzner Cloud API client with retry logic</name>
  <files>
src/lib/provisioning/hetzner-client.ts
  </files>
  <action>
Create comprehensive Hetzner Cloud API client following Pattern 1 from 03-RESEARCH.md:

1. **HetznerClient class** with constructor accepting { apiToken, baseUrl? }:
   - Store apiToken for Authorization header
   - Default baseUrl to 'https://api.hetzner.cloud/v1'

2. **Private request<T>() method** with exponential backoff:
   - Use backOff() from exponential-backoff library
   - Configure: numOfAttempts=5, startingDelay=1000ms, timeMultiple=2, maxDelay=30000ms, jitter='full'
   - Handle 429 rate limit: parse RateLimit-Reset header, calculate wait time, throw error to trigger retry
   - Handle non-OK responses: parse error body, extract error.message, throw descriptive error
   - Return typed response JSON

3. **Public API methods**:
   - `createServer(params: CreateServerRequest): Promise<CreateServerResponse>` - POST /servers
   - `getServer(serverId: number): Promise<ServerResponse>` - GET /servers/{id}
   - `deleteServer(serverId: number): Promise<void>` - DELETE /servers/{id}
   - `getServerActions(serverId: number): Promise<ActionsResponse>` - GET /servers/{id}/actions
   - `getAction(actionId: number): Promise<ActionResponse>` - GET /actions/{id}
   - `createSSHKey(params: CreateSSHKeyRequest): Promise<SSHKeyResponse>` - POST /ssh_keys
   - `deleteSSHKey(keyId: number): Promise<void>` - DELETE /ssh_keys/{id}
   - `createFirewall(params: CreateFirewallRequest): Promise<FirewallResponse>` - POST /firewalls
   - `getFirewall(firewallId: number): Promise<FirewallResponse>` - GET /firewalls/{id}

4. **Error handling**:
   - Parse Hetzner error format: { error: { code: string, message: string } }
   - Include status code and endpoint in error messages for debugging
   - Log retry attempts at debug level

5. **Rate limit handling**:
   - Check RateLimit-Remaining header on all responses
   - Log warning when remaining < 100 requests
   - On 429: extract RateLimit-Reset timestamp, calculate waitMs, throw to trigger backOff retry

Import types from src/lib/provisioning/types.ts (created in plan 03-01).

Use research code example as reference but ensure all methods match current Hetzner API v1 spec.
  </action>
  <verify>
TypeScript compilation succeeds with no errors
All methods properly typed with request/response interfaces
Error handling includes descriptive messages and status codes
Rate limit logic correctly parses headers and calculates wait time
  </verify>
  <done>
Hetzner API client fully implemented with retry logic, rate limit handling, and all required API methods for provisioning workflow
  </done>
</task>

</tasks>

<verification>
1. exponential-backoff library installed in package.json
2. HetznerClient class compiles without TypeScript errors
3. All API methods use request() wrapper with automatic retry
4. Rate limit handling extracts RateLimit-Reset header correctly
5. Error messages are descriptive and include endpoint context
</verification>

<success_criteria>
1. HetznerClient supports all CRUD operations needed for VPS lifecycle
2. Automatic retry with exponential backoff (5 attempts, max 30s delay)
3. Rate limit detection triggers intelligent wait before retry
4. Type-safe API with proper request/response TypeScript interfaces
5. Error handling provides actionable error messages with context
</success_criteria>

<output>
After completion, create `.planning/phases/03-vps-provisioning/03-02-SUMMARY.md`
</output>
