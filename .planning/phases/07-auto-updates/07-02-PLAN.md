---
phase: 07-auto-updates
plan: 02
type: execute
wave: 2
depends_on: ["07-01"]
files_modified:
  - src/lib/updates/rollout-orchestrator.ts
  - src/routes/(admin)/admin/updates/+page.server.ts
  - src/routes/(admin)/admin/updates/+page.svelte
  - src/routes/(admin)/admin/+layout.svelte
autonomous: true

must_haves:
  truths:
    - "Admin can trigger a rollout from /admin/updates page"
    - "Rollout proceeds gradually: 10% then 50% then 100% of VPSs"
    - "Rollout halts if failure rate exceeds threshold (30%)"
    - "Admin sees real-time rollout progress (per-VPS status, stage progress)"
    - "Only one rollout can run at a time"
  artifacts:
    - path: "src/lib/updates/rollout-orchestrator.ts"
      provides: "Gradual rollout logic with stage management"
      exports: ["startRollout", "getRolloutStatus", "isRolloutInProgress"]
    - path: "src/routes/(admin)/admin/updates/+page.svelte"
      provides: "Admin updates UI with trigger button and progress display"
    - path: "src/routes/(admin)/admin/updates/+page.server.ts"
      provides: "Server load and form actions for rollout management"
  key_links:
    - from: "src/lib/updates/rollout-orchestrator.ts"
      to: "src/lib/updates/update-engine.ts"
      via: "updateVPS import"
      pattern: "updateVPS"
    - from: "src/routes/(admin)/admin/updates/+page.server.ts"
      to: "src/lib/updates/rollout-orchestrator.ts"
      via: "startRollout import"
      pattern: "startRollout"
---

<objective>
Implement the gradual rollout orchestrator and admin UI for triggering and monitoring update rollouts across all user VPSs.

Purpose: Enable admin to safely deploy new Rachel8 versions with automatic gradual rollout (10% -> 50% -> 100%) and real-time progress monitoring.
Output: rollout-orchestrator.ts with stage management, admin updates page with trigger and progress UI.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/updates/update-engine.ts
@src/lib/db/schema.ts
@src/lib/provisioning/ssh-exec.ts
@src/lib/admin/guard.ts
@src/routes/(admin)/admin/+page.server.ts
@src/routes/(admin)/admin/+layout.svelte
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement rollout orchestrator with gradual deployment stages</name>
  <files>src/lib/updates/rollout-orchestrator.ts</files>
  <action>
    Create `src/lib/updates/rollout-orchestrator.ts` with:

    **Constants:**
    - `ROLLOUT_STAGES = [0.1, 0.5, 1.0]` (10%, 50%, 100%)
    - `STAGE_FAILURE_THRESHOLD = 0.3` (halt if >30% of stage fails)
    - `CONCURRENCY_LIMIT = 5` (max parallel SSH connections)
    - `INTER_STAGE_DELAY_MS = 10_000` (10s pause between stages)

    **Types:**
    ```typescript
    type RolloutStage = 'idle' | 'stage_10' | 'stage_50' | 'stage_100' | 'completed' | 'failed' | 'halted';

    interface RolloutState {
      inProgress: boolean;
      stage: RolloutStage;
      startedAt: Date | null;
      completedAt: Date | null;
      totalVPSs: number;
      updatedCount: number;
      failedCount: number;
      rolledBackCount: number;
      currentStageProgress: number; // 0-100
      error: string | null;
      vpsStatuses: VPSUpdateStatus[];
    }

    interface VPSUpdateStatus {
      userId: string;
      email: string;
      ipAddress: string;
      status: 'pending' | 'updating' | 'success' | 'failed' | 'rolled_back' | 'skipped';
      previousVersion: string | null;
      newVersion: string | null;
      error: string | null;
    }
    ```

    **Module state (in-memory):**
    - `rolloutState: RolloutState` initialized to idle defaults

    **Functions:**

    1. `isRolloutInProgress(): boolean` - Returns rolloutState.inProgress

    2. `getRolloutStatus(): RolloutState` - Returns current rolloutState (clone)

    3. `startRollout(): Promise<void>` - The main orchestration function:
       - Guard: if inProgress, throw error "Rollout already in progress"
       - Query all active, provisioned VPSs from DB (same query pattern as health-checker)
       - Shuffle the VPS list for random distribution across stages
       - Set rolloutState to inProgress with stage 'stage_10'
       - For each stage (10%, 50%, 100%):
         a. Calculate how many VPSs to update in this stage
         b. Slice the VPS list for this stage's batch
         c. Process batch with concurrency limit (5 parallel)
         d. For each VPS: call updateVPS from update-engine, track result in vpsStatuses
         e. After stage completes: check failure rate
         f. If failures > threshold: set stage='halted', inProgress=false, return
         g. If not last stage: wait INTER_STAGE_DELAY_MS, advance to next stage
       - After all stages: set stage='completed', completedAt=now, inProgress=false
       - On unhandled error: set stage='failed', error=message, inProgress=false

    Import `updateVPS` from './update-engine'.
    Import `db` from '$lib/db', `subscriptions`, `users` from '$lib/db/schema'.
    Import `eq`, `and` from 'drizzle-orm'.
    Import `decryptToken` from '$lib/crypto/encryption'.

    Use same `processInBatches` pattern as health-checker for concurrency limiting.

    The startRollout function should run fire-and-forget (caller kicks it off, then polls status).

    Log progress with `[rollout]` prefix.
  </action>
  <verify>TypeScript compiles: `cd /tmp/rachel-cloud && npx svelte-kit sync && npx tsc --noEmit 2>&1 | head -30`</verify>
  <done>rollout-orchestrator.ts exports startRollout, getRolloutStatus, isRolloutInProgress with gradual stage management and failure threshold halting.</done>
</task>

<task type="auto">
  <name>Task 2: Create admin updates page with rollout trigger and progress monitoring</name>
  <files>
    src/routes/(admin)/admin/updates/+page.server.ts
    src/routes/(admin)/admin/updates/+page.svelte
    src/routes/(admin)/admin/+layout.svelte
  </files>
  <action>
    **1. Create `src/routes/(admin)/admin/updates/+page.server.ts`:**

    - Import `requireAdmin` from '$lib/admin/guard'
    - Import `startRollout, getRolloutStatus, isRolloutInProgress` from '$lib/updates/rollout-orchestrator'
    - Import `db`, `subscriptions`, `users` from schema

    `load` function:
    - Call requireAdmin(event)
    - Get rollout status from getRolloutStatus()
    - Query count of active provisioned VPSs
    - Return { rolloutStatus, activeVPSCount }

    `actions`:
    - `trigger`: Call requireAdmin, guard against inProgress, call startRollout() (fire-and-forget with void + .catch), return { triggered: true }

    **2. Create `src/routes/(admin)/admin/updates/+page.svelte`:**

    Admin updates page with:
    - Page header: "Update Rollout" with description
    - Status card showing current rollout state (idle/in-progress/completed/halted/failed)
    - "Start Rollout" button (disabled when in progress or no VPSs)
    - Progress section (visible when rollout in progress or completed):
      - Stage indicator (10% / 50% / 100%) with visual progress
      - Stats: total, updated, failed, rolled back counts
      - Per-VPS status table: userId (truncated), email, IP, status badge, version info
    - Use SvelteKit form actions for trigger (enhance:false for simplicity)
    - Client-side polling: when rollout is in progress, fetch `/admin/updates` every 3 seconds via `invalidateAll()` from '$app/navigation'
    - Use same Tailwind styling patterns as existing admin pages (indigo accents, cards, badges)
    - Status badges: pending=gray, updating=yellow, success=green, failed=red, rolled_back=orange, halted=red

    **3. Update `src/routes/(admin)/admin/+layout.svelte`:**

    Add an "Updates" nav link to the `navLinks` array:
    ```
    { href: '/admin/updates', label: 'Updates', icon: 'arrow-path' }
    ```
    Add the corresponding SVG icon in the template (a refresh/arrow-path icon):
    ```svg
    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
    ```
  </action>
  <verify>
    1. TypeScript compiles: `cd /tmp/rachel-cloud && npx svelte-kit sync && npx tsc --noEmit 2>&1 | head -30`
    2. Build succeeds: `cd /tmp/rachel-cloud && npm run build 2>&1 | tail -20`
  </verify>
  <done>Admin updates page at /admin/updates shows rollout status, has trigger button, displays per-VPS progress. Admin sidebar includes "Updates" nav link. Build passes.</done>
</task>

</tasks>

<verification>
1. rollout-orchestrator.ts exports startRollout, getRolloutStatus, isRolloutInProgress
2. Rollout stages are 10%, 50%, 100% with 30% failure threshold
3. Admin updates page loads at /admin/updates with rollout trigger
4. Admin sidebar has "Updates" navigation link
5. TypeScript compiles and build succeeds
</verification>

<success_criteria>
- Admin can trigger update rollout from /admin/updates
- Rollout proceeds gradually (10% -> 50% -> 100%)
- Failed updates auto-rollback; >30% failures halt rollout
- Admin sees real-time progress with per-VPS status
- Only one rollout can run at a time
</success_criteria>

<output>
After completion, create `.planning/phases/07-auto-updates/07-02-SUMMARY.md`
</output>
