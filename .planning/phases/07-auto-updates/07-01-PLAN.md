---
phase: 07-auto-updates
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - src/lib/updates/update-engine.ts
autonomous: true

must_haves:
  truths:
    - "Each VPS has version tracking fields (currentVersion, targetVersion, updateStatus, previousVersion, lastUpdateAt)"
    - "Update engine can SSH into a VPS, pull latest code, install deps, restart, and verify"
    - "Failed updates automatically rollback to previous commit hash"
    - "Health checker skips VPSs that are currently being updated"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "Version tracking columns on subscriptions table"
      contains: "currentVersion"
    - path: "src/lib/updates/update-engine.ts"
      provides: "Per-VPS update and rollback functions"
      exports: ["updateVPS", "rollbackVPS", "getVPSVersion"]
  key_links:
    - from: "src/lib/updates/update-engine.ts"
      to: "src/lib/provisioning/ssh-exec.ts"
      via: "execSSHCommand import"
      pattern: "execSSHCommand"
    - from: "src/lib/updates/update-engine.ts"
      to: "src/lib/db/schema.ts"
      via: "subscriptions table update"
      pattern: "subscriptions"
---

<objective>
Add version tracking to the database schema and implement the core update engine that can update or rollback a single VPS via SSH.

Purpose: Foundation for the rollout system -- each VPS needs version tracking, and the update engine provides the atomic update/rollback operations that the orchestrator will call.
Output: DB schema with version fields, update-engine.ts with updateVPS/rollbackVPS functions.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@src/lib/db/schema.ts
@src/lib/provisioning/ssh-exec.ts
@src/lib/monitoring/health-checker.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add version tracking columns to subscriptions table</name>
  <files>src/lib/db/schema.ts</files>
  <action>
    Add five new columns to the `subscriptions` table in schema.ts:

    1. `currentVersion` - text('current_version') - stores the current git commit hash running on the VPS
    2. `targetVersion` - text('target_version') - the target commit hash during a rollout (null when not updating)
    3. `updateStatus` - text('update_status', { enum: ['idle', 'updating', 'success', 'failed', 'rolled_back'] }) with default 'idle'
    4. `previousVersion` - text('previous_version') - stores the pre-update hash for rollback capability
    5. `lastUpdateAt` - integer('last_update_at', { mode: 'timestamp' }) - when the last update completed

    Place these after the existing VPS tracking fields (after `sshPrivateKey`), grouped with a comment `// Update tracking fields (Phase 7)`.
  </action>
  <verify>Run `bunx drizzle-kit push` from the project root to apply schema changes. Verify no errors.</verify>
  <done>Schema has 5 new version tracking columns on subscriptions table. DB migration applied successfully.</done>
</task>

<task type="auto">
  <name>Task 2: Implement update engine with updateVPS, rollbackVPS, and getVPSVersion</name>
  <files>src/lib/updates/update-engine.ts</files>
  <action>
    Create `src/lib/updates/update-engine.ts` with the following exports:

    **Constants:**
    - `UPDATE_CONNECT_TIMEOUT_MS = 30_000` (longer than health check's 10s)
    - `UPDATE_COMMAND_TIMEOUT_MS = 120_000` (bun install can be slow)
    - `SERVICE_STARTUP_WAIT_MS = 5_000` (wait for service to start after restart)
    - `RACHEL_DIR = '/home/rachel/rachel'` (where Rachel8 is cloned on VPSs)

    **Types:**
    ```typescript
    interface UpdateResult {
      success: boolean;
      previousVersion: string | null;
      newVersion: string | null;
      error?: string;
    }
    ```

    **Functions:**

    1. `getVPSVersion(host: string, privateKey: string): Promise<string | null>`
       - SSH: `cd /home/rachel/rachel && git rev-parse HEAD`
       - Returns trimmed commit hash or null on error

    2. `updateVPS(host: string, privateKey: string, userId: string): Promise<UpdateResult>`
       - Step 1: Get current version via `git rev-parse HEAD` (store as previousVersion)
       - Step 2: Update DB: set updateStatus='updating', targetVersion=null
       - Step 3: `cd /home/rachel/rachel && git pull origin main` (60s timeout)
       - Step 4: `cd /home/rachel/rachel && bun install` (120s timeout)
       - Step 5: `sudo systemctl restart rachel8` (30s timeout)
       - Step 6: Sleep SERVICE_STARTUP_WAIT_MS
       - Step 7: `sudo systemctl is-active rachel8` - verify exit code 0 and output "active"
       - Step 8: Get new version via `git rev-parse HEAD`
       - Step 9: Update DB: currentVersion=newVersion, previousVersion=prevHash, updateStatus='success', lastUpdateAt=now
       - On ANY failure: call rollbackVPS, update DB: updateStatus='failed'
       - Return UpdateResult

    3. `rollbackVPS(host: string, privateKey: string, previousHash: string): Promise<UpdateResult>`
       - Step 1: `cd /home/rachel/rachel && git checkout <previousHash>` (30s timeout)
       - Step 2: `cd /home/rachel/rachel && bun install` (120s timeout)
       - Step 3: `sudo systemctl restart rachel8` (30s timeout)
       - Step 4: Sleep SERVICE_STARTUP_WAIT_MS
       - Step 5: `sudo systemctl is-active rachel8` - verify
       - Step 6: Get version via `git rev-parse HEAD`
       - Return UpdateResult with success/failure
       - On rollback failure, log error but don't recurse

    Import `execSSHCommand` from '$lib/provisioning/ssh-exec'.
    Import `db` from '$lib/db' and `subscriptions` from '$lib/db/schema'.
    Import `eq` from 'drizzle-orm'.
    Import `decryptToken` from '$lib/crypto/encryption' for SSH key decryption.

    Use a helper `sleep(ms)` implemented as `new Promise(resolve => setTimeout(resolve, ms))`.

    All SSH commands should use `username: 'rachel'` (the default in ssh-exec).

    Log progress with `[update-engine]` prefix for consistency with project style.
  </action>
  <verify>TypeScript compiles without errors: `cd /tmp/rachel-cloud && npx svelte-kit sync && npx tsc --noEmit 2>&1 | head -30`</verify>
  <done>update-engine.ts exports updateVPS, rollbackVPS, getVPSVersion. All functions use SSH to execute git/bun/systemctl commands with proper timeouts, error handling, and DB persistence.</done>
</task>

</tasks>

<verification>
1. Schema has version tracking columns (currentVersion, targetVersion, updateStatus, previousVersion, lastUpdateAt)
2. update-engine.ts exports three functions: updateVPS, rollbackVPS, getVPSVersion
3. update-engine.ts imports and uses execSSHCommand from ssh-exec.ts
4. update-engine.ts updates subscriptions table on success/failure
5. TypeScript compiles without errors
</verification>

<success_criteria>
- DB schema extended with version tracking fields
- Update engine can SSH into a VPS, pull code, install deps, restart, and verify
- Failed updates trigger automatic rollback to previous commit hash
- All version state persisted to database
</success_criteria>

<output>
After completion, create `.planning/phases/07-auto-updates/07-01-SUMMARY.md`
</output>
