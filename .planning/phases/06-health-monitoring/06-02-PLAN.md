---
phase: 06-health-monitoring
plan: 02
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/lib/monitoring/health-notifications.ts
  - src/lib/monitoring/health-checker.ts
  - src/lib/email/sender.ts
autonomous: true

must_haves:
  truths:
    - "User receives email when their Rachel instance goes down"
    - "User receives email when their Rachel instance recovers"
    - "Admin receives email when a circuit breaker trips (3 consecutive failures)"
    - "Emails are only sent on state transitions, never repeated for the same event"
    - "Auto-recovery restarts the rachel8 service and confirms it comes back up"
  artifacts:
    - path: "src/lib/monitoring/health-notifications.ts"
      provides: "Health event email notification functions"
      exports: ["sendInstanceDownEmail", "sendInstanceRecoveredEmail", "sendCircuitBreakerAlert"]
    - path: "src/lib/email/sender.ts"
      provides: "Extended email sender with health notification functions"
      contains: "sendInstanceDownEmail"
    - path: "src/lib/monitoring/health-checker.ts"
      provides: "Health checker with integrated notifications"
      contains: "sendInstanceDownEmail"
  key_links:
    - from: "src/lib/monitoring/health-checker.ts"
      to: "src/lib/monitoring/health-notifications.ts"
      via: "notification calls on state transitions"
      pattern: "sendInstance(Down|Recovered)Email|sendCircuitBreakerAlert"
    - from: "src/lib/monitoring/health-notifications.ts"
      to: "src/lib/email/sender.ts"
      via: "Resend email sending"
      pattern: "resend\\.emails\\.send"
    - from: "src/lib/monitoring/health-checker.ts"
      to: "src/lib/provisioning/vps-status.ts"
      via: "restartRachelService for auto-recovery"
      pattern: "restartRachelService"
---

<objective>
Add email notifications for health events and integrate auto-recovery actions into the health check sweep.

Purpose: Users need to know when their instance goes down and when it recovers. The admin needs to be alerted when a circuit breaker trips. Auto-recovery should attempt to restart the service before notifying the user of a prolonged outage.
Output: Health notification emails (down, recovered, circuit breaker tripped) and integrated auto-recovery with notification triggers.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-health-monitoring/06-01-SUMMARY.md
@src/lib/email/sender.ts
@src/lib/provisioning/vps-status.ts
@src/lib/monitoring/health-checker.ts
@src/lib/monitoring/circuit-breaker.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create health notification email functions</name>
  <files>
    src/lib/monitoring/health-notifications.ts
    src/lib/email/sender.ts
  </files>
  <action>
    **1. Create `src/lib/monitoring/health-notifications.ts`:**

    This module provides three email notification functions for health events. Follow the same pattern as `sender.ts` (HTML email templates, Resend, error handling that returns boolean, never throws).

    **`sendInstanceDownEmail(userEmail, userName)`:**
    - Subject: "Rachel Instance Down - Auto-Recovery in Progress"
    - Body: Inform user their Rachel instance was detected as down. Explain auto-recovery is being attempted. Include link to dashboard (`${baseUrl}/dashboard`). Use red/warning color scheme similar to `sendPaymentFailedEmail`.
    - Only called on first detection (status transition from healthy to unhealthy), NOT on every failed check.

    **`sendInstanceRecoveredEmail(userEmail, userName, downtimeMinutes)`:**
    - Subject: "Rachel Instance Recovered"
    - Body: Inform user their instance is back online. Show approximate downtime duration. Include link to dashboard. Use green/success color scheme.
    - Called when status transitions from unhealthy/down/circuit_open back to healthy.

    **`sendCircuitBreakerAlert(adminEmail, userId, userEmail, vpsIp, consecutiveFailures, lastError)`:**
    - Subject: "[ADMIN ALERT] Circuit Breaker Tripped for {userEmail}"
    - Body: Alert admin that auto-recovery has failed 3 times for a user. Include: user email, VPS IP, consecutive failure count, last error message, timestamp. Suggest manual investigation. Use red/critical color scheme.
    - Called when circuit breaker transitions to open state.

    All three functions should:
    - Use `process.env.RESEND_API_KEY` via a Resend instance (can import the shared one from sender.ts or create a new instance)
    - Use `process.env.RESEND_FROM_EMAIL` with fallback `'Rachel Cloud <noreply@rachel.cloud>'`
    - Use `process.env.PUBLIC_BASE_URL` with fallback `'http://localhost:5173'`
    - Return `Promise<boolean>` (true if sent, false on error)
    - Never throw -- email failure should not break health monitoring
    - Log success/failure with `[health-notifications]` prefix

    **2. Optionally add these functions to `src/lib/email/sender.ts` as re-exports**, or keep them in the monitoring module. Recommendation: keep them in `health-notifications.ts` since they are monitoring-specific. The sender.ts file is for billing-related emails.
  </action>
  <verify>
    1. Run `bun run check` to verify TypeScript compiles cleanly.
    2. Verify all three functions are exported from `health-notifications.ts`.
    3. Verify email templates include proper HTML structure (DOCTYPE, head, body, responsive meta viewport).
  </verify>
  <done>
    Three email notification functions exist: instance down, instance recovered, circuit breaker alert. All follow existing email patterns (HTML templates, Resend, boolean return, no-throw error handling).
  </done>
</task>

<task type="auto">
  <name>Task 2: Integrate notifications and auto-recovery into health checker</name>
  <files>
    src/lib/monitoring/health-checker.ts
  </files>
  <action>
    Update `health-checker.ts` to call notification functions on state transitions and integrate auto-recovery restart logic.

    **Notification integration points:**

    1. **On first failure (consecutiveFailures goes from 0 to 1):**
       - Status transitions from 'healthy' to 'unhealthy'
       - Attempt auto-restart via `restartRachelService(host, encryptedPrivateKey)`
       - If restart succeeds: mark healthy, do NOT send any email (brief blip recovered automatically)
       - If restart fails: send `sendInstanceDownEmail()` to user, update `lastNotifiedDownAt`
       - Guard: only send if `lastNotifiedDownAt` is null or was more than 5 minutes ago

    2. **On subsequent failures (consecutiveFailures 2):**
       - Status stays 'unhealthy', no additional email (already notified)
       - Attempt restart if circuit breaker allows

    3. **On circuit breaker trip (consecutiveFailures reaches 3):**
       - Status transitions to 'circuit_open'
       - Send `sendCircuitBreakerAlert()` to admin (use `process.env.ADMIN_EMAIL`)
       - Do NOT send another down email to user (they were already notified)

    4. **On recovery (any non-healthy state -> healthy):**
       - Calculate downtime: `Date.now() - lastFailureAt` (in minutes, rounded)
       - Send `sendInstanceRecoveredEmail()` to user with downtime duration
       - Update `lastNotifiedUpAt`
       - Guard: only send if `lastNotifiedDownAt` is set (meaning we previously told them it was down)

    **Auto-recovery flow per VPS check:**
    ```
    1. SSH check: `systemctl is-active rachel8`
    2. If healthy:
       a. Was previously unhealthy? -> mark recovered, send recovery email
       b. Was already healthy? -> update lastCheckAt, lastHealthyAt
    3. If unhealthy:
       a. Get effective circuit state
       b. If circuit allows restart:
          - Attempt restart via restartRachelService()
          - If restart succeeds: mark healthy, handle recovery notification
          - If restart fails: record failure via circuit breaker
            - If circuit just tripped: send admin alert
            - If first failure: send user down email
       c. If circuit blocks restart: log skip, update lastCheckAt only
    4. If SSH connection fails entirely:
       - Record failure (but do NOT attempt restart -- host unreachable)
       - Follow same circuit breaker logic
    ```

    **User data lookup for emails:**
    The health check sweep queries subscriptions. To send emails, you need the user's email and name. Modify the initial query to JOIN with users table:
    ```typescript
    const activeVPSs = await db
      .select({
        userId: subscriptions.userId,
        vpsIpAddress: subscriptions.vpsIpAddress,
        sshPrivateKey: subscriptions.sshPrivateKey,
        hetznerServerId: subscriptions.hetznerServerId,
        userEmail: users.email,
        userName: users.name,
      })
      .from(subscriptions)
      .innerJoin(users, eq(subscriptions.userId, users.id))
      .where(
        and(
          eq(subscriptions.status, 'active'),
          eq(subscriptions.vpsProvisioned, true),
          eq(subscriptions.provisioningStatus, 'ready')
        )
      );
    ```

    **Important:** Email sending is fire-and-forget within the sweep. If email fails, log it but continue the sweep. Never let email failures affect health monitoring logic.
  </action>
  <verify>
    1. Run `bun run check` to verify TypeScript compiles cleanly.
    2. Review health-checker.ts to confirm:
       - Notification imports are present
       - State transition detection works (healthy->unhealthy, unhealthy->healthy, circuit trip)
       - Guard conditions prevent notification spam
       - Auto-restart is attempted before sending down notification
       - User email/name are available from DB query
    3. Verify ADMIN_EMAIL env var is used for circuit breaker alerts.
  </verify>
  <done>
    Health checker sends email on state transitions: down notification to user (after failed auto-restart), recovery notification to user (with downtime duration), circuit breaker alert to admin. Notifications are guarded against spam. Auto-recovery attempts restart before notifying user. Email failures do not break health monitoring.
  </done>
</task>

</tasks>

<verification>
1. `bun run check` passes with no TypeScript errors
2. Health notification module exports all three email functions
3. Health checker integrates notifications at correct state transition points
4. No notification spam -- emails only sent on state changes, not every check
5. Auto-restart is attempted via restartRachelService before notifying user
6. Admin alert fires exactly once when circuit breaker trips
7. Recovery email includes downtime duration
8. Email failures are logged but do not crash the health sweep
</verification>

<success_criteria>
- Three email notification functions exist (instance down, recovered, circuit breaker alert)
- Health checker calls notifications on state transitions only
- Auto-recovery attempts restart before sending down notification
- If restart succeeds silently (first failure), no email is sent to user
- Circuit breaker alert goes to ADMIN_EMAIL
- Recovery email shows approximate downtime
- Email failures are caught and logged, never crash the monitor
- Notification spam is prevented via lastNotifiedAt timestamps
</success_criteria>

<output>
After completion, create `.planning/phases/06-health-monitoring/06-02-SUMMARY.md`
</output>
