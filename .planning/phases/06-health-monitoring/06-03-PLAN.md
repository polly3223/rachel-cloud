---
phase: 06-health-monitoring
plan: 03
type: execute
wave: 2
depends_on: ["06-01"]
files_modified:
  - src/routes/(app)/dashboard/+page.server.ts
  - src/routes/(app)/dashboard/+page.svelte
  - src/routes/(admin)/admin/+page.server.ts
  - src/routes/(admin)/admin/+page.svelte
  - src/lib/admin/data.ts
autonomous: true

must_haves:
  truths:
    - "User sees health status indicator on their dashboard (healthy/unhealthy/down/circuit_open)"
    - "User sees last health check time on their dashboard"
    - "Admin sees health overview for all VPSs (total healthy, unhealthy, circuit breakers tripped)"
    - "Admin sees per-user health status in the users table"
  artifacts:
    - path: "src/routes/(app)/dashboard/+page.server.ts"
      provides: "Health check data loaded for user dashboard"
      contains: "healthChecks"
    - path: "src/routes/(app)/dashboard/+page.svelte"
      provides: "Health status indicator in user dashboard"
      contains: "health"
    - path: "src/routes/(admin)/admin/+page.server.ts"
      provides: "Health overview data loaded for admin dashboard"
      contains: "healthChecks"
    - path: "src/routes/(admin)/admin/+page.svelte"
      provides: "Health overview section in admin dashboard"
      contains: "health"
    - path: "src/lib/admin/data.ts"
      provides: "Admin data with health metrics"
      contains: "healthChecks"
  key_links:
    - from: "src/routes/(app)/dashboard/+page.server.ts"
      to: "src/lib/db/schema.ts"
      via: "query healthChecks table for user's health data"
      pattern: "healthChecks"
    - from: "src/lib/admin/data.ts"
      to: "src/lib/db/schema.ts"
      via: "query healthChecks table for all users"
      pattern: "healthChecks"
---

<objective>
Display health monitoring status in both the user dashboard and admin dashboard.

Purpose: Users need to see at a glance whether their Rachel instance is healthy. Admins need a fleet-wide health overview to identify problems quickly.
Output: Health status indicators in user dashboard, health overview section and per-user health status in admin dashboard.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-health-monitoring/06-01-SUMMARY.md
@src/routes/(app)/dashboard/+page.server.ts
@src/routes/(app)/dashboard/+page.svelte
@src/routes/(admin)/admin/+page.server.ts
@src/routes/(admin)/admin/+page.svelte
@src/lib/admin/data.ts
@src/lib/db/schema.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add health status to user dashboard</name>
  <files>
    src/routes/(app)/dashboard/+page.server.ts
    src/routes/(app)/dashboard/+page.svelte
  </files>
  <action>
    **1. Update `src/routes/(app)/dashboard/+page.server.ts`:**

    Add a query to fetch the user's health check record from the `healthChecks` table. Import `healthChecks` from schema and `eq` from drizzle-orm.

    After the existing VPS status load, add:
    ```typescript
    import { healthChecks } from '$lib/db/schema';

    // Inside the load function, after vpsStatus loading:
    let healthStatus = null;
    if (subscription?.vpsProvisioned) {
      const healthRecord = await db.query.healthChecks.findFirst({
        where: eq(healthChecks.userId, session.user.id)
      });
      if (healthRecord) {
        healthStatus = {
          status: healthRecord.status,
          lastCheckAt: healthRecord.lastCheckAt,
          lastHealthyAt: healthRecord.lastHealthyAt,
          consecutiveFailures: healthRecord.consecutiveFailures,
          circuitState: healthRecord.circuitState,
          totalChecks: healthRecord.totalChecks,
          totalRecoveries: healthRecord.totalRecoveries,
        };
      }
    }
    ```

    Return `healthStatus` alongside existing data in the return object.

    **2. Update `src/routes/(app)/dashboard/+page.svelte`:**

    Add a health status indicator to the existing "Server Status" card. Place it in the grid alongside Status, IP, Datacenter, and Uptime.

    Add a new grid item showing the automated health monitoring status:

    ```
    Health Monitor
    [colored dot] Healthy / Unhealthy / Down / Circuit Open
    Last check: 30s ago
    ```

    Health status display logic:
    - `healthy` -> green dot + "Healthy" badge (`bg-green-100 text-green-800`)
    - `unhealthy` -> yellow dot + "Unhealthy" badge (`bg-yellow-100 text-yellow-800`) + show consecutive failures count
    - `down` -> red dot + "Down" badge (`bg-red-100 text-red-800`)
    - `circuit_open` -> red dot + "Recovery Failed" badge (`bg-red-100 text-red-800`) + note that admin has been notified
    - No health record yet -> gray dot + "Monitoring Starting" badge (`bg-gray-100 text-gray-600`)

    Show "Last check: Xs ago" using relative time calculation. If `lastCheckAt` is null, show "Not yet checked".

    Place the health indicator as a new row BELOW the existing Status/IP/Datacenter/Uptime grid, or add it as a 5th item in the grid. Recommendation: add a dedicated small card/banner between the Server Status card and the Actions card. Style it as:
    - A compact horizontal bar with: health dot + status text + "Last checked: Xs ago" on the left, and total checks / recoveries counters on the right
    - Background color matches the health status (green tint for healthy, yellow for unhealthy, red for down)
    - Keep it minimal -- this is supplementary info, not the main focus

    The health status should update when the user refreshes the page (server-side load). No need for client-side polling of health status -- the existing 30s VPS status refresh is sufficient, and health data comes from the DB, not live SSH.
  </action>
  <verify>
    1. Run `bun run check` to verify TypeScript compiles cleanly.
    2. Navigate to `/dashboard` -- verify health status section appears below Server Status card (will show "Monitoring Starting" or "Not yet checked" in dev without active VPS).
    3. Verify responsive layout works on mobile.
  </verify>
  <done>
    User dashboard shows health monitoring status with colored indicator, status text, last check time, and lifetime counters. Health data is loaded from the healthChecks table on page load.
  </done>
</task>

<task type="auto">
  <name>Task 2: Add health overview to admin dashboard</name>
  <files>
    src/lib/admin/data.ts
    src/routes/(admin)/admin/+page.server.ts
    src/routes/(admin)/admin/+page.svelte
  </files>
  <action>
    **1. Update `src/lib/admin/data.ts`:**

    Extend `AdminUser` interface to include health status:
    ```typescript
    export interface AdminUser {
      // ... existing fields
      healthStatus: string | null;       // healthy, unhealthy, down, circuit_open
      consecutiveFailures: number;
      lastCheckAt: Date | null;
      circuitState: string | null;
    }
    ```

    Extend `AdminOverview` interface to include health metrics:
    ```typescript
    export interface AdminOverview {
      // ... existing fields
      healthyVPSCount: number;
      unhealthyVPSCount: number;
      circuitOpenCount: number;
    }
    ```

    Update the `getAdminOverview()` query to LEFT JOIN with `healthChecks`:
    ```typescript
    import { healthChecks } from '$lib/db/schema';

    const allUsers = await db
      .select({
        // ... existing fields
        healthStatus: healthChecks.status,
        consecutiveFailures: healthChecks.consecutiveFailures,
        lastCheckAt: healthChecks.lastCheckAt,
        circuitState: healthChecks.circuitState,
      })
      .from(users)
      .leftJoin(subscriptions, eq(users.id, subscriptions.userId))
      .leftJoin(healthChecks, eq(users.id, healthChecks.userId))
      .orderBy(users.createdAt);
    ```

    Map the new fields in `mappedUsers` and compute aggregate counts:
    ```typescript
    const healthyVPSCount = mappedUsers.filter(u => u.healthStatus === 'healthy').length;
    const unhealthyVPSCount = mappedUsers.filter(u => u.healthStatus === 'unhealthy' || u.healthStatus === 'down').length;
    const circuitOpenCount = mappedUsers.filter(u => u.healthStatus === 'circuit_open').length;
    ```

    Return these in the overview object.

    **2. Update `src/routes/(admin)/admin/+page.svelte`:**

    **Add a Health Overview stats card row** between the existing overview stats and the Revenue & Costs section. Create a new row of 3 stat cards:

    - **Healthy VPSs:** Green icon, count of healthy VPSs (bg-green-50 icon)
    - **Unhealthy/Down:** Yellow/Red icon, count of unhealthy + down VPSs (bg-yellow-50 icon, or bg-red-50 if count > 0)
    - **Circuit Breakers Tripped:** Red icon, count of circuit_open VPSs (bg-red-50 icon). This is the most critical -- if > 0, show prominent styling.

    **Add health status column to the users table:**

    Add a new column "Health" between "VPS Status" and "IP Address" columns:
    - Show a colored badge similar to subscription status:
      - `healthy` -> `bg-green-100 text-green-800` "Healthy"
      - `unhealthy` -> `bg-yellow-100 text-yellow-800` "Unhealthy (X failures)"
      - `down` -> `bg-red-100 text-red-800` "Down"
      - `circuit_open` -> `bg-red-100 text-red-800` "Circuit Open" (bold/prominent)
      - No health record -> `bg-gray-100 text-gray-600` "Not Monitored"

    Add helper functions for health status display:
    ```typescript
    function healthStatusColor(status: string | null): string {
      switch (status) {
        case 'healthy': return 'bg-green-100 text-green-800';
        case 'unhealthy': return 'bg-yellow-100 text-yellow-800';
        case 'down': return 'bg-red-100 text-red-800';
        case 'circuit_open': return 'bg-red-100 text-red-800 font-bold';
        default: return 'bg-gray-100 text-gray-600';
      }
    }

    function healthStatusLabel(status: string | null, failures: number): string {
      switch (status) {
        case 'healthy': return 'Healthy';
        case 'unhealthy': return `Unhealthy (${failures})`;
        case 'down': return 'Down';
        case 'circuit_open': return 'Circuit Open';
        default: return 'Not Monitored';
      }
    }
    ```

    Also update the mobile card layout to include health status.

    **Styling notes:**
    - Use the same indigo/purple admin accent established in Phase 5
    - Health overview cards should use the same card component pattern as existing overview stats
    - Circuit breaker count should be visually alarming if > 0 (red background, bold text)
  </action>
  <verify>
    1. Run `bun run check` to verify TypeScript compiles cleanly.
    2. Navigate to `/admin` -- verify health overview stat cards appear.
    3. Verify users table has a "Health" column with colored badges.
    4. Verify mobile card layout includes health status.
    5. Verify all counts default to 0 when no health records exist yet.
  </verify>
  <done>
    Admin dashboard shows fleet-wide health metrics (healthy/unhealthy/circuit_open counts) in stat cards and per-user health status in the users table. Circuit breaker trips are visually prominent. Mobile layout includes health data.
  </done>
</task>

</tasks>

<verification>
1. `bun run check` passes with no TypeScript errors
2. User dashboard shows health status indicator when VPS is provisioned
3. Admin dashboard shows health overview stats (3 cards)
4. Admin users table includes health status column with colored badges
5. Both dashboards handle the "no health record yet" state gracefully
6. Mobile layouts are responsive and include health data
7. Health data is loaded server-side (no additional client-side API calls)
</verification>

<success_criteria>
- User dashboard displays health monitoring status with colored indicator
- User sees last check time as relative time ("30s ago")
- Admin dashboard shows fleet health summary (healthy/unhealthy/circuit open counts)
- Admin users table has health status column with badges
- Circuit breaker tripped state is visually prominent in admin view
- All views handle empty/missing health data gracefully
- Responsive mobile layouts work correctly
</success_criteria>

<output>
After completion, create `.planning/phases/06-health-monitoring/06-03-SUMMARY.md`
</output>
