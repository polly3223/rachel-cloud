---
phase: 05-dashboard-controls
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/hooks.server.ts
  - src/lib/admin/guard.ts
  - src/routes/(admin)/admin/+layout.svelte
  - src/routes/(admin)/admin/+layout.server.ts
autonomous: true

must_haves:
  truths:
    - "Admin user (matching ADMIN_EMAIL) can access /admin routes"
    - "Non-admin users are redirected away from /admin routes"
    - "Unauthenticated users are redirected to /login from /admin routes"
    - "Admin layout has its own sidebar navigation distinct from user dashboard"
  artifacts:
    - path: "src/lib/admin/guard.ts"
      provides: "requireAdmin() and isAdmin() utility functions"
      exports: ["requireAdmin", "isAdmin"]
    - path: "src/hooks.server.ts"
      provides: "Admin route guard in handle function"
      contains: "pathname.startsWith('/admin')"
    - path: "src/routes/(admin)/admin/+layout.svelte"
      provides: "Admin dashboard layout with sidebar"
      min_lines: 30
    - path: "src/routes/(admin)/admin/+layout.server.ts"
      provides: "Admin layout data loader with auth check"
      exports: ["load"]
  key_links:
    - from: "src/hooks.server.ts"
      to: "src/lib/admin/guard.ts"
      via: "import isAdmin"
      pattern: "isAdmin"
    - from: "src/routes/(admin)/admin/+layout.server.ts"
      to: "src/lib/admin/guard.ts"
      via: "import requireAdmin"
      pattern: "requireAdmin"
---

<objective>
Create admin authentication middleware and the admin route group skeleton with its own layout.

Purpose: Establish the foundation for the admin dashboard by protecting /admin routes with a hardcoded email check and creating the admin-specific layout with navigation sidebar.

Output: Admin guard utility, hooks.server.ts admin middleware, admin route group with layout.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard-controls/05-RESEARCH.md
@src/hooks.server.ts
@src/lib/auth/session.ts
@src/routes/(app)/dashboard/+layout.svelte
@src/routes/(app)/dashboard/+layout.server.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin guard utility and update hooks.server.ts</name>
  <files>src/lib/admin/guard.ts, src/hooks.server.ts</files>
  <action>
    Create `src/lib/admin/guard.ts` with two functions:

    1. `isAdmin(email: string): boolean` — Checks if the given email matches `process.env.ADMIN_EMAIL`. IMPORTANT: Compare both sides with `.toLowerCase()` to handle case insensitivity. Return false if ADMIN_EMAIL env var is not set.

    2. `requireAdmin(event: RequestEvent): Promise<NonNullable<Session>>` — Calls `requireAuth(event)` from `$lib/auth/session`, then checks `isAdmin(session.user.email)`. If not admin, throws `redirect(302, '/dashboard')`. Returns the session if admin.

    Then update `src/hooks.server.ts`:
    - Import `isAdmin` from `$lib/admin/guard`
    - Import `redirect` from `@sveltejs/kit`
    - After the existing session attachment (`event.locals.session = await getSession(event)`), add an admin route guard block:
      ```
      if (event.url.pathname.startsWith('/admin')) {
        const session = event.locals.session;
        if (!session || !isAdmin(session.user.email)) {
          throw redirect(302, '/dashboard');
        }
      }
      ```
    - Keep all existing auth logic intact (Better Auth handler, session attachment)
    - Do NOT use `sequence()` — the existing handle function is simple enough to add the guard inline

    Add to `.env.example` (or note in comments): `ADMIN_EMAIL=lorenzo@example.com`
  </action>
  <verify>
    - `src/lib/admin/guard.ts` exports both `isAdmin` and `requireAdmin`
    - `src/hooks.server.ts` contains the `/admin` pathname check
    - TypeScript compilation passes: `cd /tmp/rachel-cloud && npx svelte-check --tsconfig ./tsconfig.json 2>&1 | tail -5` (may have pre-existing issues, focus on new files)
  </verify>
  <done>Admin guard utility created with case-insensitive email check. hooks.server.ts redirects non-admin users from /admin/* routes to /dashboard.</done>
</task>

<task type="auto">
  <name>Task 2: Create admin route group with layout</name>
  <files>src/routes/(admin)/admin/+layout.svelte, src/routes/(admin)/admin/+layout.server.ts</files>
  <action>
    Create the admin route group directory structure: `src/routes/(admin)/admin/`

    Create `src/routes/(admin)/admin/+layout.server.ts`:
    - Import `requireAdmin` from `$lib/admin/guard`
    - Export a `load` function (LayoutServerLoad) that calls `requireAdmin(event)` and returns `{ user: session.user }` (same pattern as the existing user dashboard layout.server.ts but using requireAdmin instead of requireAuth)

    Create `src/routes/(admin)/admin/+layout.svelte`:
    - Accept `data` and `children` props (Svelte 5 style: `let { data, children } = $props()`)
    - Create an admin sidebar layout similar in structure to the existing dashboard layout (`src/routes/(app)/dashboard/+layout.svelte`) but with:
      - Title: "Rachel Cloud Admin" instead of "Rachel Cloud"
      - Different accent color: use purple/indigo instead of blue to visually distinguish admin from user dashboard
      - Navigation links:
        - `/admin` — Overview (icon: chart-bar)
        - `/admin/users` — Users (icon: users)
        - `/admin/revenue` — Revenue (icon: dollar-sign)  [placeholder, content in Plan 04]
        - `/admin/infrastructure` — Infrastructure (icon: server) [placeholder, content in Plan 04]
      - User info section at bottom showing admin user's name/email
      - Sign out button (reuse same pattern: `authClient.signOut()`)
      - "Back to Dashboard" link at bottom of sidebar pointing to `/dashboard`
      - Mobile hamburger menu (same pattern as existing dashboard layout)
    - Use `{@render children()}` for the content area

    Create a placeholder `src/routes/(admin)/admin/+page.svelte`:
    - Simple page with heading "Admin Dashboard"
    - Subtitle "Overview coming in Phase 5 Plan 04"
    - This is a placeholder to verify the route group and layout work

    Create `src/routes/(admin)/admin/+page.server.ts`:
    - Import `requireAdmin` from `$lib/admin/guard`
    - Simple load function that calls requireAdmin and returns empty data (actual data loading in Plan 04)
  </action>
  <verify>
    - Directory `src/routes/(admin)/admin/` exists with all 4 files
    - Layout has sidebar navigation with admin-specific links
    - Layout uses purple/indigo accent (not blue)
    - `+layout.server.ts` uses `requireAdmin` (not `requireAuth`)
    - Dev server starts without errors: `cd /tmp/rachel-cloud && timeout 10 npx vite build 2>&1 | tail -10` (build check)
  </verify>
  <done>Admin route group created at (admin)/admin/ with dedicated layout, sidebar navigation, and placeholder overview page. Admin routes are protected by requireAdmin in both hooks.server.ts and layout.server.ts (defense in depth).</done>
</task>

</tasks>

<verification>
1. Admin guard utility exists at `src/lib/admin/guard.ts` with `isAdmin()` and `requireAdmin()` exports
2. `hooks.server.ts` redirects non-admin users from `/admin/*` to `/dashboard`
3. Admin route group exists at `src/routes/(admin)/admin/` with layout and placeholder page
4. Admin layout has distinct visual style (purple/indigo) and admin-specific navigation
5. TypeScript compiles without errors in new files
</verification>

<success_criteria>
- Non-admin users visiting `/admin` are redirected to `/dashboard`
- Unauthenticated users visiting `/admin` are redirected to `/login`
- Admin user (matching ADMIN_EMAIL env var, case-insensitive) can access `/admin`
- Admin layout renders with sidebar, navigation links, and content area
- Admin layout is visually distinct from user dashboard (different accent color)
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-controls/05-01-SUMMARY.md`
</output>
