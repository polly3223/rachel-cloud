---
phase: 05-dashboard-controls
plan: 03
type: execute
wave: 2
depends_on: ["05-02"]
files_modified:
  - src/routes/(app)/dashboard/+page.svelte
  - src/routes/(app)/dashboard/+page.server.ts
autonomous: true

must_haves:
  truths:
    - "User sees live VPS status (running/stopped/error) on dashboard within 1 second of page load"
    - "User can click Restart and see rachel8 service restart within 30 seconds"
    - "User can view recent log lines from their Rachel instance"
    - "User sees VPS connection info (IP address, uptime)"
    - "Dashboard handles error states gracefully (VPS offline, SSH unreachable)"
  artifacts:
    - path: "src/routes/(app)/dashboard/+page.server.ts"
      provides: "Server-side VPS status loading"
      exports: ["load"]
    - path: "src/routes/(app)/dashboard/+page.svelte"
      provides: "Enhanced dashboard with status, restart, logs, connection info"
      min_lines: 100
  key_links:
    - from: "src/routes/(app)/dashboard/+page.server.ts"
      to: "src/lib/provisioning/vps-status.ts"
      via: "import getVPSStatus"
      pattern: "getVPSStatus"
    - from: "src/routes/(app)/dashboard/+page.svelte"
      to: "/api/vps/restart"
      via: "fetch POST"
      pattern: "api/vps/restart"
    - from: "src/routes/(app)/dashboard/+page.svelte"
      to: "/api/vps/logs"
      via: "fetch GET"
      pattern: "api/vps/logs"
---

<objective>
Enhance the user dashboard with live server status, restart capability, log viewing, and connection info.

Purpose: Give users visibility into their Rachel instance and self-service tools (restart, logs) so they can troubleshoot issues without contacting support.

Output: Enhanced dashboard page with status card, restart button, logs panel, and connection info.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard-controls/05-RESEARCH.md
@.planning/phases/05-dashboard-controls/05-02-SUMMARY.md
@src/routes/(app)/dashboard/+page.svelte
@src/routes/(app)/dashboard/+page.server.ts
@src/lib/provisioning/vps-status.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Enhance dashboard page.server.ts with VPS status loading</name>
  <files>src/routes/(app)/dashboard/+page.server.ts</files>
  <action>
    Update `src/routes/(app)/dashboard/+page.server.ts` to load VPS status on the server side:

    Keep existing imports and logic. Add:
    - Import `getVPSStatus` from `$lib/provisioning/vps-status`
    - After getting subscription, if `subscription.vpsProvisioned && subscription.hetznerServerId`:
      - Call `getVPSStatus(subscription.hetznerServerId)` wrapped in try/catch
      - On error, set vpsStatus to `{ status: 'unknown', ip: subscription.vpsIpAddress || '', datacenter: '', created: '' }`
    - Return the existing data PLUS `vpsStatus` (or null if not provisioned)

    Updated return shape:
    ```typescript
    return {
      subscription,
      hasActiveSubscription: subscription?.status === 'active',
      isGracePeriod: subscription?.status === 'grace_period',
      vpsStatus: vpsStatusResult ?? null,  // NEW
    };
    ```

    Do NOT load uptime or logs on server side (those are fetched client-side via API to avoid blocking page load).
  </action>
  <verify>
    - `+page.server.ts` imports and calls `getVPSStatus`
    - Return value includes `vpsStatus` property
    - Error handling prevents page crash if Hetzner API is down
  </verify>
  <done>Dashboard server load function fetches VPS status from Hetzner API. Status is available on initial page render without client-side fetch delay.</done>
</task>

<task type="auto">
  <name>Task 2: Rebuild dashboard page with status, restart, logs, and connection info</name>
  <files>src/routes/(app)/dashboard/+page.svelte</files>
  <action>
    Rewrite `src/routes/(app)/dashboard/+page.svelte` to include the following sections when VPS is provisioned and ready. KEEP all existing provisioning flow UI (deploy button, provisioning progress, failed state, no subscription state) â€” add new sections for the "running" state.

    When VPS is provisioned and status is 'ready' (the existing "Running" section), REPLACE the simple "Rachel is running" message with a full dashboard:

    **Section 1: Server Status Card** (top of page)
    - Show Hetzner server status with colored indicator:
      - 'running' = green dot + "Running"
      - 'off' / 'stopping' = red dot + "Stopped"
      - 'starting' / 'initializing' = yellow dot + "Starting"
      - Other = gray dot + status text
    - Show VPS IP address (from data.subscription.vpsIpAddress)
    - Show datacenter location (from data.vpsStatus?.datacenter)
    - Show uptime (fetched client-side via GET /api/vps/status, displayed after load)
    - Auto-refresh status every 30 seconds using `$effect()` with setInterval + cleanup

    **Section 2: Actions Card** (below status)
    - **Restart Button**: "Restart Rachel" button
      - On click: POST to `/api/vps/restart`
      - Show spinner while restarting
      - Disable button during restart
      - Show success toast (green banner) or error (red banner) after completion
      - After successful restart, refresh status after 5 seconds
    - Style: White card with border, action buttons inside

    **Section 3: Recent Logs Card** (below actions)
    - Header: "Recent Logs" with a "Refresh" button
    - Log display area: monospace font, dark background (bg-gray-900 text-green-400), scrollable container (max-height 400px), overflow-y-auto
    - On mount: fetch logs via GET `/api/vps/logs?lines=100`
    - Show loading skeleton while fetching
    - Show "No logs available" if empty
    - Show error message if fetch fails
    - "Refresh" button re-fetches logs
    - Optional: "Auto-refresh" toggle that polls every 10 seconds (use $state for toggle, $effect for interval)

    **Section 4: Connection Info Card** (below logs or sidebar)
    - Server IP: displayed with copy-to-clipboard button
    - Provisioned date: from subscription.provisionedAt (formatted nicely)
    - Server hostname: from subscription.vpsHostname (if available)

    **Keep existing sections for other states:**
    - Provisioning in progress (no changes)
    - Failed provisioning (no changes)
    - Ready to deploy / no subscription (no changes)

    **Technical details:**
    - Use Svelte 5 runes: `$state()`, `$derived()`, `$effect()`
    - All fetch calls wrapped in try/catch
    - Use the `data` prop from `$props()` for server-loaded data
    - Copy-to-clipboard: use `navigator.clipboard.writeText()` with fallback
    - Responsive: stack vertically on mobile, use grid on larger screens where appropriate
    - All intervals cleaned up in `$effect()` return functions
  </action>
  <verify>
    - Dashboard shows server status card with colored indicator when VPS is running
    - Restart button exists and calls POST /api/vps/restart
    - Logs section exists with monospace display and refresh capability
    - Connection info shows IP with copy button
    - All existing provisioning states (deploying, failed, not deployed) still render correctly
    - Build passes: `cd /tmp/rachel-cloud && npx vite build 2>&1 | tail -10`
  </verify>
  <done>User dashboard enhanced with live server status, restart button, log viewer, and connection info. All states handled (running, stopped, error, provisioning, not deployed). Auto-refresh for status every 30 seconds.</done>
</task>

</tasks>

<verification>
1. Dashboard shows VPS status from Hetzner API on initial page load
2. Status auto-refreshes every 30 seconds
3. Restart button sends POST to /api/vps/restart and shows feedback
4. Logs panel fetches and displays journalctl output in monospace terminal style
5. Connection info shows IP, datacenter, uptime
6. All existing dashboard states (provisioning, failed, deploy, no subscription) still work
7. Intervals are properly cleaned up on component unmount
</verification>

<success_criteria>
- User opens dashboard and sees current server status within 1 second (server-side loaded)
- User clicks Restart and sees feedback within 30 seconds
- User sees recent logs in a terminal-style display
- Dashboard displays VPS IP, uptime, and datacenter info
- Dashboard is responsive on mobile devices
- Error states (SSH unreachable, VPS stopped) show helpful messages instead of crashing
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-controls/05-03-SUMMARY.md`
</output>
