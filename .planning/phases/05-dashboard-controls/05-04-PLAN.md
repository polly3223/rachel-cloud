---
phase: 05-dashboard-controls
plan: 04
type: execute
wave: 2
depends_on: ["05-01", "05-02"]
files_modified:
  - src/routes/(admin)/admin/+page.svelte
  - src/routes/(admin)/admin/+page.server.ts
  - src/lib/admin/data.ts
autonomous: true

must_haves:
  truths:
    - "Admin sees a list of all users with their subscription status"
    - "Admin sees revenue overview (total MRR, active subscriber count)"
    - "Admin sees cost overview (number of running VPSs, estimated Hetzner costs)"
    - "Admin sees VPS status per user (provisioned, IP, Hetzner status)"
    - "Admin dashboard only accessible to admin user (ADMIN_EMAIL)"
  artifacts:
    - path: "src/lib/admin/data.ts"
      provides: "Admin data aggregation functions"
      exports: ["getAdminOverview", "getAllUsersWithStatus"]
    - path: "src/routes/(admin)/admin/+page.server.ts"
      provides: "Admin dashboard data loader"
      exports: ["load"]
    - path: "src/routes/(admin)/admin/+page.svelte"
      provides: "Admin dashboard overview page with users, revenue, costs, VPS status"
      min_lines: 100
  key_links:
    - from: "src/routes/(admin)/admin/+page.server.ts"
      to: "src/lib/admin/data.ts"
      via: "import getAdminOverview"
      pattern: "getAdminOverview"
    - from: "src/lib/admin/data.ts"
      to: "src/lib/db/schema.ts"
      via: "import users, subscriptions"
      pattern: "users.*subscriptions"
---

<objective>
Build the admin dashboard with users list, revenue overview, costs overview, and VPS status per user.

Purpose: Give Lorenzo (the admin) full visibility into the business: who's subscribed, how much revenue, what infrastructure is running, and the health status of each user's VPS.

Output: Admin data aggregation functions, admin dashboard page with overview cards and users table.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/05-dashboard-controls/05-RESEARCH.md
@.planning/phases/05-dashboard-controls/05-01-SUMMARY.md
@.planning/phases/05-dashboard-controls/05-02-SUMMARY.md
@src/lib/db/schema.ts
@src/lib/admin/guard.ts
@src/routes/(admin)/admin/+layout.svelte
@src/routes/(admin)/admin/+layout.server.ts
@src/lib/provisioning/vps-status.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create admin data aggregation functions</name>
  <files>src/lib/admin/data.ts</files>
  <action>
    Create `src/lib/admin/data.ts` with data aggregation functions for the admin dashboard.

    Import from: `$lib/db`, `$lib/db/schema` (users, subscriptions), `drizzle-orm` (eq, count, sql), `$lib/provisioning/vps-status` (getVPSStatus).

    Define types:

    ```typescript
    export interface AdminUser {
      id: string;
      email: string;
      name: string | null;
      createdAt: Date;
      subscriptionStatus: string | null;  // 'none' | 'active' | 'grace_period' | 'canceled' | null
      vpsProvisioned: boolean;
      vpsIpAddress: string | null;
      hetznerServerId: number | null;
      provisioningStatus: string | null;
      provisionedAt: Date | null;
    }

    export interface AdminOverview {
      totalUsers: number;
      activeSubscribers: number;
      gracePeriodUsers: number;
      canceledUsers: number;
      totalMRR: number;           // activeSubscribers * 20
      runningVPSCount: number;    // users where vpsProvisioned = true
      estimatedMonthlyCost: number; // runningVPSCount * 3.49 (EUR)
      profitMargin: number;       // (MRR - estimatedCost) / MRR * 100
      users: AdminUser[];
    }
    ```

    Export function `getAdminOverview(): Promise<AdminOverview>`:
    - Query all users with LEFT JOIN on subscriptions:
      ```typescript
      const allUsers = await db
        .select({
          id: users.id,
          email: users.email,
          name: users.name,
          createdAt: users.createdAt,
          subscriptionStatus: subscriptions.status,
          vpsProvisioned: subscriptions.vpsProvisioned,
          vpsIpAddress: subscriptions.vpsIpAddress,
          hetznerServerId: subscriptions.hetznerServerId,
          provisioningStatus: subscriptions.provisioningStatus,
          provisionedAt: subscriptions.provisionedAt,
        })
        .from(users)
        .leftJoin(subscriptions, eq(users.id, subscriptions.userId))
        .orderBy(users.createdAt);
      ```
    - Calculate aggregates:
      - `activeSubscribers`: count where subscriptionStatus === 'active'
      - `gracePeriodUsers`: count where subscriptionStatus === 'grace_period'
      - `canceledUsers`: count where subscriptionStatus === 'canceled'
      - `totalMRR`: activeSubscribers * 20 (USD)
      - `runningVPSCount`: count where vpsProvisioned === true (use `=== true` or `=== 1` since SQLite booleans may be 0/1)
      - `estimatedMonthlyCost`: runningVPSCount * 3.49 (EUR, approximate)
      - `profitMargin`: if totalMRR > 0, `((totalMRR - estimatedMonthlyCost) / totalMRR) * 100`, else 0
    - Map users to AdminUser[] (handle SQLite boolean: `vpsProvisioned` may be 0/1, convert to boolean with `!!`)
    - Return the complete AdminOverview object
    - Wrap in try/catch, log errors

    Note: Do NOT call Hetzner API to check live status of each user's VPS in this function (too slow for N users, would hit rate limits). The Hetzner server status per user is fetched on-demand if needed. The admin dashboard shows provisioning status from the DB, not live Hetzner status.
  </action>
  <verify>
    - `src/lib/admin/data.ts` exists with `AdminUser`, `AdminOverview` types and `getAdminOverview` function
    - Function queries both users and subscriptions tables
    - Aggregation calculates MRR, costs, profit margin correctly
    - No Hetzner API calls (avoids rate limiting)
  </verify>
  <done>Admin data aggregation function created. Queries all users with subscription data, calculates MRR ($20 * active subscribers), estimated Hetzner costs (EUR 3.49 * running VPSs), and profit margin.</done>
</task>

<task type="auto">
  <name>Task 2: Build admin dashboard overview page</name>
  <files>src/routes/(admin)/admin/+page.server.ts, src/routes/(admin)/admin/+page.svelte</files>
  <action>
    Update `src/routes/(admin)/admin/+page.server.ts`:
    - Import `requireAdmin` from `$lib/admin/guard`
    - Import `getAdminOverview` from `$lib/admin/data`
    - Load function calls `requireAdmin(event)` then `getAdminOverview()`
    - Return `{ overview }` with the full AdminOverview data

    Rewrite `src/routes/(admin)/admin/+page.svelte`:
    - Accept `data` prop with `$props()`
    - Use Tailwind CSS for all styling (purple/indigo accent to match admin layout)

    **Section 1: Overview Stats Cards** (top row, 4 cards in a grid)
    - Card 1: "Total Users" — `data.overview.totalUsers` — icon: users
    - Card 2: "Monthly Revenue" — `$${data.overview.totalMRR}/mo` — icon: dollar-sign, green text
    - Card 3: "Running VPSs" — `data.overview.runningVPSCount` — icon: server
    - Card 4: "Est. Monthly Cost" — `EUR ${data.overview.estimatedMonthlyCost.toFixed(2)}` — icon: receipt, with profit margin badge

    Grid: `grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-4`
    Card style: white background, rounded-lg shadow, p-6, with icon in colored circle at top

    **Section 2: Revenue & Costs Summary** (below stats)
    - Simple card showing:
      - Revenue: $X/mo from Y active subscribers
      - Costs: ~EUR X/mo from Z running VPSs (EUR 3.49 per VPS)
      - Profit margin: X% (colored: green if >60%, yellow if 40-60%, red if <40%)
      - Subscribers breakdown: X active, Y grace period, Z canceled

    **Section 3: Users Table** (main section)
    - Full-width table with columns:
      - User (email + name)
      - Status (subscription status badge: green for active, yellow for grace_period, red for canceled, gray for none/null)
      - VPS Status (provisioning status: green "Ready" for ready, yellow for in-progress states, red for failed, gray for not provisioned)
      - IP Address (monospace, or "—" if no VPS)
      - Provisioned Date (formatted, or "—")
      - Member Since (users.createdAt, formatted)
    - Status badges: rounded-full, small text, colored backgrounds
    - Table is responsive: on mobile, switch to card layout instead of table
    - Sort by: most recently created first (default)
    - If no users, show "No users yet" empty state

    **Formatting helpers (define in script):**
    - `formatDate(date: Date | null): string` — returns "Feb 14, 2026" format or "—"
    - `statusColor(status: string | null): string` — returns Tailwind classes for badge color
    - `provisioningStatusLabel(status: string | null): string` — human-readable provisioning status

    **Svelte 5 style:**
    - Use `$props()` for data
    - Use `$derived()` for computed values if needed
    - No $state needed (this is a read-only dashboard, no client-side mutations)
  </action>
  <verify>
    - Admin page loads data via `getAdminOverview()`
    - Overview cards show MRR, user count, VPS count, estimated costs
    - Users table displays all users with subscription and VPS status
    - Status badges have appropriate colors
    - Page renders without errors: `cd /tmp/rachel-cloud && npx vite build 2>&1 | tail -10`
  </verify>
  <done>Admin dashboard overview page built with stats cards (MRR, users, VPSs, costs), revenue/costs summary with profit margin, and a full users table showing subscription status, VPS status, IPs, and dates.</done>
</task>

</tasks>

<verification>
1. Admin data aggregation queries all users with subscription JOIN
2. MRR calculation: active_subscribers * $20
3. Cost estimation: running_VPSs * EUR 3.49
4. Profit margin calculated and displayed with color coding
5. Users table shows all users with status badges, VPS info, dates
6. Page only accessible to admin (ADMIN_EMAIL) — enforced by hooks + requireAdmin
7. Responsive layout: cards on mobile, table on desktop
</verification>

<success_criteria>
- Admin opens /admin and sees 4 overview stat cards (users, MRR, VPSs, costs)
- Revenue and costs summary shows profit margin percentage
- Users table lists every user with their subscription status, VPS status, and IP
- Status badges are color-coded (green/yellow/red/gray)
- Dates are formatted human-readably
- Page loads quickly (single DB query, no external API calls)
- Non-admin users cannot access the page
</success_criteria>

<output>
After completion, create `.planning/phases/05-dashboard-controls/05-04-SUMMARY.md`
</output>
