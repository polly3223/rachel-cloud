---
phase: 01-authentication-user-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - bun.lockb
  - drizzle.config.ts
  - src/lib/db/schema.ts
  - src/lib/db/index.ts
  - src/lib/auth/config.ts
  - src/lib/crypto/encryption.ts
  - .env.example
autonomous: true
user_setup:
  - service: google-oauth
    why: "Google OAuth provider for Better Auth"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> Create OAuth 2.0 Client"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials -> OAuth 2.0 Client credentials"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Add authorized redirect URI: http://localhost:5173/api/auth/callback/google"
        location: "OAuth 2.0 Client settings"
  - service: encryption
    why: "Encryption key for Claude OAuth tokens"
    env_vars:
      - name: ENCRYPTION_KEY
        source: "Generate with: node -e \"console.log(require('crypto').randomBytes(32).toString('base64'))\""

must_haves:
  truths:
    - "Database schema exists for users, sessions, accounts, and Claude tokens"
    - "Better Auth can authenticate users via email/password and Google OAuth"
    - "Claude OAuth tokens can be encrypted and decrypted at application level"
    - "Environment variables are documented for required secrets"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "Drizzle schema with users, sessions, accounts, claude_tokens tables"
      contains: "sqliteTable"
      min_lines: 60
    - path: "src/lib/db/index.ts"
      provides: "Database client singleton using bun:sqlite"
      exports: ["db"]
      min_lines: 10
    - path: "src/lib/auth/config.ts"
      provides: "Better Auth configuration with SQLite adapter"
      exports: ["auth"]
      min_lines: 30
    - path: "src/lib/crypto/encryption.ts"
      provides: "AES-256-GCM encryption utilities for tokens"
      exports: ["encryptToken", "decryptToken"]
      min_lines: 40
    - path: "drizzle.config.ts"
      provides: "Drizzle ORM configuration for SQLite"
      min_lines: 10
  key_links:
    - from: "src/lib/auth/config.ts"
      to: "src/lib/db/index.ts"
      via: "imports db client"
      pattern: "import.*db.*from.*['\"].*db"
    - from: "src/lib/db/index.ts"
      to: "Database()"
      via: "bun:sqlite import"
      pattern: "Database.*from.*['\"]bun:sqlite"
    - from: "src/lib/crypto/encryption.ts"
      to: "process.env.ENCRYPTION_KEY"
      via: "reads encryption key from env"
      pattern: "process\\.env\\.ENCRYPTION_KEY"
---

<objective>
Establish the database, authentication, and encryption foundation for Rachel Cloud.

Purpose: Create the core infrastructure for user authentication using Better Auth with SQLite (via Drizzle ORM and bun:sqlite) and implement AES-256-GCM encryption for Claude OAuth tokens. This provides the secure foundation for all subsequent authentication flows.

Output: A working SvelteKit project with Better Auth configured, database schema defined, and token encryption utilities ready for use.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/tmp/rachel-cloud/.planning/PROJECT.md
@/tmp/rachel-cloud/.planning/ROADMAP.md
@/tmp/rachel-cloud/.planning/phases/01-authentication-user-foundation/01-CONTEXT.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Initialize SvelteKit project with Bun and install dependencies</name>
  <files>
    package.json
    bun.lockb
    svelte.config.js
    vite.config.ts
    tsconfig.json
  </files>
  <action>
Initialize SvelteKit project in /tmp/rachel-cloud using Bun as the runtime:
- Run `cd /tmp/rachel-cloud && bun create svelte@latest .` (select TypeScript, strict mode, no demo code)
- Install Better Auth: `bun add better-auth`
- Install Drizzle ORM and SQLite: `bun add drizzle-orm`
- Install Drizzle Kit for migrations: `bun add -D drizzle-kit`
- Install Better Auth Drizzle adapter: `bun add @better-auth/drizzle-adapter`
- Install crypto for encryption (Node built-in, no install needed but ensure import works)
- Ensure tsconfig.json has "strict": true and uses Bun types
- Create .env file with placeholder values for GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET, ENCRYPTION_KEY
- Create .env.example with documentation for each variable
  </action>
  <verify>
Run `bun --version` and `bun run dev` to confirm SvelteKit starts without errors. Check that package.json contains better-auth, drizzle-orm, and @better-auth/drizzle-adapter.
  </verify>
  <done>
SvelteKit project initialized with TypeScript strict mode, Better Auth and Drizzle dependencies installed, Bun runtime configured, .env.example created with all required variables documented.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create database schema and client with Drizzle + bun:sqlite</name>
  <files>
    src/lib/db/schema.ts
    src/lib/db/index.ts
    drizzle.config.ts
  </files>
  <action>
Create Drizzle schema for Better Auth tables plus Claude tokens:

**src/lib/db/schema.ts:**
- Define `users` table: id (text, primary key), email (text, unique, not null), emailVerified (integer boolean), name (text), image (text), createdAt (integer), updatedAt (integer)
- Define `sessions` table: id (text, primary key), userId (text, foreign key to users.id), expiresAt (integer, not null), ipAddress (text), userAgent (text)
- Define `accounts` table: id (text, primary key), userId (text, foreign key to users.id), provider (text, not null), providerAccountId (text, not null), accessToken (text), refreshToken (text), expiresAt (integer), unique constraint on [provider, providerAccountId]
- Define `claudeTokens` table: id (text, primary key), userId (text, foreign key to users.id, unique), encryptedAccessToken (text, not null), encryptedRefreshToken (text, not null), expiresAt (integer, not null), createdAt (integer), updatedAt (integer)
- Use `sqliteTable` from drizzle-orm/sqlite-core
- Export all tables

**src/lib/db/index.ts:**
- Import `Database` from "bun:sqlite"
- Create singleton database instance pointing to "data/rachel-cloud.db"
- Import `drizzle` from "drizzle-orm/bun-sqlite" and wrap the Database instance
- Export `db` as the Drizzle client
- Create data directory if it doesn't exist

**drizzle.config.ts:**
- Configure Drizzle Kit with schema path, out directory for migrations, driver: "bun:sqlite", dbCredentials pointing to data/rachel-cloud.db
  </action>
  <verify>
Run `bun run drizzle-kit generate` to generate SQL migrations. Verify migrations appear in drizzle/ directory with CREATE TABLE statements for users, sessions, accounts, and claudeTokens. Run `bun run drizzle-kit push` to apply schema to SQLite database and check data/rachel-cloud.db exists.
  </verify>
  <done>
Drizzle schema defined with all four tables (users, sessions, accounts, claudeTokens), database client singleton created using bun:sqlite, migrations generated and applied successfully, SQLite database file exists at data/rachel-cloud.db.
  </done>
</task>

<task type="auto">
  <name>Task 3: Configure Better Auth and implement token encryption</name>
  <files>
    src/lib/auth/config.ts
    src/lib/crypto/encryption.ts
    src/hooks.server.ts
  </files>
  <action>
**src/lib/auth/config.ts:**
- Import `betterAuth` from "better-auth"
- Import `drizzleAdapter` from "@better-auth/drizzle-adapter"
- Import db and schema from lib/db
- Configure Better Auth with:
  - database: drizzleAdapter(db, { provider: "sqlite", schema })
  - emailAndPassword: { enabled: true }
  - socialProviders: { google: { clientId: process.env.GOOGLE_CLIENT_ID, clientSecret: process.env.GOOGLE_CLIENT_SECRET, enabled: true } }
  - session: { expiresIn: 60 * 60 * 24 * 7 (7 days), updateAge: 60 * 60 * 24 (refresh daily) }
  - basePath: "/api/auth"
  - baseURL: process.env.PUBLIC_BASE_URL || "http://localhost:5173"
- Export `auth` instance

**src/lib/crypto/encryption.ts:**
- Import crypto from "node:crypto"
- Implement `encryptToken(plaintext: string): string` using AES-256-GCM:
  - Generate random 12-byte IV
  - Use ENCRYPTION_KEY from env (base64 decode to buffer)
  - Create cipher with crypto.createCipheriv('aes-256-gcm', key, iv)
  - Encrypt plaintext, get authTag
  - Return base64-encoded JSON: {iv, encrypted, authTag}
- Implement `decryptToken(ciphertext: string): string`:
  - Parse base64 JSON to get iv, encrypted, authTag
  - Create decipher with crypto.createDecipheriv
  - Set authTag, decrypt
  - Return plaintext
- Validate ENCRYPTION_KEY exists and is 32 bytes (base64 decoded)
- Export both functions

**src/hooks.server.ts:**
- Import auth from lib/auth/config
- Export handle function that wraps auth.handler() for SvelteKit request handling
  </action>
  <verify>
Write a simple test script that calls encryptToken("test-token") and decryptToken(result) and verifies the output matches "test-token". Run `bun run dev` and check that Better Auth routes exist by curling http://localhost:5173/api/auth/session (should return 401 or session data, not 404).
  </verify>
  <done>
Better Auth configured with Drizzle adapter using SQLite, Google OAuth provider enabled, AES-256-GCM encryption utilities implemented and tested, Better Auth request handler integrated into SvelteKit hooks, all environment variables validated.
  </done>
</task>

</tasks>

<verification>
1. Run `bun run drizzle-kit studio` and verify all four tables exist with correct columns
2. Run `bun run dev` and verify SvelteKit starts without errors
3. Curl http://localhost:5173/api/auth/session and verify Better Auth responds (401 Unauthorized is correct for no session)
4. Test encryption utilities with a manual script: `bun run test-encrypt.ts` that encrypts and decrypts a string
5. Verify .env.example documents all required variables with clear instructions
</verification>

<success_criteria>
- SvelteKit project runs with Bun runtime
- Database schema contains users, sessions, accounts, and claudeTokens tables
- Better Auth is configured with email/password and Google OAuth providers
- Token encryption utilities encrypt and decrypt correctly using AES-256-GCM
- All dependencies are installed and environment variables documented
- No placeholder/mock implementations remain
</success_criteria>

<output>
After completion, create `.planning/phases/01-authentication-user-foundation/01-01-SUMMARY.md`
</output>
