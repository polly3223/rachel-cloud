---
phase: 01-authentication-user-foundation
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - package.json
  - drizzle.config.ts
  - src/db/schema.ts
  - src/db/index.ts
  - src/auth/config.ts
  - src/auth/encryption.ts
autonomous: true
user_setup:
  - service: google-oauth
    why: "Google OAuth for user authentication"
    env_vars:
      - name: GOOGLE_CLIENT_ID
        source: "Google Cloud Console -> APIs & Services -> Credentials -> Create OAuth 2.0 Client ID"
      - name: GOOGLE_CLIENT_SECRET
        source: "Google Cloud Console -> APIs & Services -> Credentials"
    dashboard_config:
      - task: "Create OAuth 2.0 Client ID"
        location: "Google Cloud Console -> APIs & Services -> Credentials"
      - task: "Add authorized redirect URI"
        location: "Set to http://localhost:3000/api/auth/callback/google for development"
  - service: postgresql
    why: "Database for user data and sessions"
    env_vars:
      - name: DATABASE_URL
        source: "PostgreSQL connection string (postgresql://user:password@host:port/database)"
    dashboard_config:
      - task: "Create PostgreSQL database"
        location: "Local PostgreSQL installation or cloud provider (e.g., Railway, Supabase, Neon)"
  - service: encryption
    why: "Encryption key for OAuth tokens"
    env_vars:
      - name: ENCRYPTION_KEY
        source: "Generate using: node -e \"console.log(require('crypto').randomBytes(32).toString('hex'))\""

must_haves:
  truths:
    - "Database schema supports users, sessions, and encrypted OAuth accounts"
    - "Better Auth is configured with Drizzle adapter and PostgreSQL"
    - "AES-256-GCM encryption/decryption functions handle OAuth tokens securely"
    - "Environment variables control all external service configuration"
  artifacts:
    - path: "src/db/schema.ts"
      provides: "User, Session, and Account tables with Drizzle schema"
      contains: "pgTable.*users.*sessions.*accounts"
      min_lines: 50
    - path: "src/auth/config.ts"
      provides: "Better Auth configuration with Drizzle adapter"
      exports: ["auth"]
      min_lines: 30
    - path: "src/auth/encryption.ts"
      provides: "Token encryption using AES-256-GCM"
      exports: ["TokenEncryption"]
      min_lines: 50
    - path: "src/db/index.ts"
      provides: "Database connection and Drizzle client"
      exports: ["db"]
  key_links:
    - from: "src/auth/config.ts"
      to: "src/db/index.ts"
      via: "drizzleAdapter(db, {provider: 'postgresql'})"
      pattern: "drizzleAdapter.*db"
    - from: "src/auth/encryption.ts"
      to: "process.env.ENCRYPTION_KEY"
      via: "Constructor reads from environment"
      pattern: "process\\.env\\.ENCRYPTION_KEY"
---

<objective>
Establish authentication foundation for Rachel Cloud by setting up Better Auth with Drizzle ORM, PostgreSQL, and AES-256-GCM token encryption.

Purpose: Provide secure, production-ready authentication infrastructure supporting email/password and Google OAuth flows with encrypted token storage.

Output: Database schema, Better Auth configuration, token encryption utilities, and all dependencies installed.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/01-authentication-user-foundation/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Install dependencies and initialize database</name>
  <files>
package.json
drizzle.config.ts
src/db/index.ts
  </files>
  <action>
Install Better Auth, Drizzle ORM, PostgreSQL driver, and supporting libraries:
```bash
bun add better-auth drizzle-orm postgres hono-rate-limiter pkce-challenge
bun add -d drizzle-kit @types/node
```

Create `drizzle.config.ts` for database migrations with PostgreSQL configuration:
- Set schema path to `./src/db/schema.ts`
- Set output directory to `./src/db/migrations`
- Read DATABASE_URL from environment
- Configure verbose logging for development

Create `src/db/index.ts` with Drizzle PostgreSQL client:
- Import postgres from `postgres` package
- Import drizzle from `drizzle-orm/postgres-js`
- Create connection using DATABASE_URL environment variable
- Export `db` instance for use throughout application
- Add error handling for missing DATABASE_URL

Follow pattern from research: https://orm.drizzle.team/docs/get-started-postgresql
  </action>
  <verify>
```bash
cd /tmp/rachel-cloud && bun install
cd /tmp/rachel-cloud && bun run drizzle-kit --version
cd /tmp/rachel-cloud && node -e "require('./src/db/index.ts')"
```
All commands succeed without errors
  </verify>
  <done>
Dependencies installed, Drizzle configured, database connection exports successfully
  </done>
</task>

<task type="auto">
  <name>Create database schema with encrypted token support</name>
  <files>
src/db/schema.ts
  </files>
  <action>
Create Drizzle schema with three tables following Better Auth requirements:

**users table:**
- id: text (primary key, UUID)
- email: text (unique, not null)
- emailVerified: timestamp (nullable)
- name: text (nullable)
- createdAt: timestamp (default now, not null)
- updatedAt: timestamp (default now, not null)

**sessions table:**
- id: text (primary key, generated by Better Auth)
- userId: text (foreign key to users.id, not null)
- expiresAt: timestamp (not null)
- ipAddress: text (nullable, for security tracking)
- userAgent: text (nullable, for security tracking)
- createdAt: timestamp (default now, not null)

**accounts table (OAuth tokens stored here):**
- id: text (primary key, generated by Better Auth)
- userId: text (foreign key to users.id, not null)
- accountId: text (not null, external provider account ID)
- providerId: text (not null, e.g., "google", "claude")
- accessToken: text (nullable, encrypted with AES-256-GCM)
- refreshToken: text (nullable, encrypted with AES-256-GCM)
- expiresAt: timestamp (nullable, token expiration)
- scope: text (nullable, OAuth scopes)
- createdAt: timestamp (default now, not null)
- updatedAt: timestamp (default now, not null)

Use `pgTable` from drizzle-orm/pg-core.
Export all tables for use in Better Auth adapter.
Follow schema structure from research (01-RESEARCH.md, "Database Schema" section).
  </action>
  <verify>
```bash
cd /tmp/rachel-cloud && bun run drizzle-kit push
```
Schema successfully applied to database
  </verify>
  <done>
Database schema created with users, sessions, and accounts tables; schema supports encrypted token storage
  </done>
</task>

<task type="auto">
  <name>Implement AES-256-GCM token encryption</name>
  <files>
src/auth/encryption.ts
  </files>
  <action>
Create TokenEncryption class with AES-256-GCM encryption for OAuth tokens:

**Class structure:**
- Algorithm: "aes-256-gcm"
- IV length: 12 bytes (GCM standard)
- Tag length: 16 bytes (GCM standard)
- Key: 32 bytes (256 bits), read from ENCRYPTION_KEY environment variable

**Methods:**
- `constructor(encryptionKey?: string)`: Initialize with key from parameter or env var; validate key is exactly 32 bytes
- `encrypt(plaintext: string): string`: Encrypt token using AES-256-GCM; return format "iv~encrypted~tag" (all base64-encoded)
- `decrypt(ciphertext: string): string`: Decrypt token; validate format has 3 parts; throw on invalid format or auth tag failure
- `static generateKey(): string`: Generate 32-byte random key for initial setup (helper method)

**Security requirements:**
- Generate random IV for each encryption (never reuse)
- Include authentication tag in output for integrity verification
- Throw clear errors on missing/invalid encryption key
- Use Node.js crypto module (native, no external dependencies)

Follow exact implementation from research (01-RESEARCH.md, "Complete Token Encryption/Decryption Module" section).
Use crypto.createCipheriv and crypto.createDecipheriv with proper IV and tag handling.
  </action>
  <verify>
```bash
cd /tmp/rachel-cloud && node -e "
const { TokenEncryption } = require('./src/auth/encryption.ts');
process.env.ENCRYPTION_KEY = require('crypto').randomBytes(32).toString('hex');
const enc = new TokenEncryption();
const encrypted = enc.encrypt('test_token_12345');
const decrypted = enc.decrypt(encrypted);
console.assert(decrypted === 'test_token_12345', 'Encryption/decryption failed');
console.log('✓ Token encryption working');
"
```
Test passes, encryption/decryption roundtrip succeeds
  </verify>
  <done>
AES-256-GCM token encryption implemented with encrypt/decrypt methods; validates against test tokens
  </done>
</task>

<task type="auto">
  <name>Configure Better Auth with Drizzle and Google OAuth</name>
  <files>
src/auth/config.ts
  </files>
  <action>
Create Better Auth configuration using betterAuth function:

**Database adapter:**
- Use drizzleAdapter from "better-auth/adapters/drizzle"
- Pass db instance from src/db/index.ts
- Set provider to "postgresql"

**Authentication methods:**
- Enable emailAndPassword with minPasswordLength: 8, maxPasswordLength: 128
- Add Google OAuth provider with GOOGLE_CLIENT_ID and GOOGLE_CLIENT_SECRET from env vars
- Set trustedOrigins to [process.env.FRONTEND_URL || "http://localhost:5173"] for CORS

**Session configuration:**
- expiresIn: 60 * 60 * 24 * 7 (7 days)
- updateAge: 60 * 60 * 24 (refresh session every 24 hours for active users)
- cookieCache: enabled with 5-minute maxAge

**Advanced settings:**
- cookiePrefix: "rachel_cloud"
- useSecureCookies: process.env.NODE_ENV === "production" (HTTP-only in prod, false in dev)
- generateId: () => crypto.randomUUID()

Export `auth` instance for mounting in Hono routes.

Follow configuration pattern from research (01-RESEARCH.md, "Complete Better Auth Setup" section).
DO NOT implement Claude OAuth yet—that comes in plan 01-03 after basic auth is working.
  </action>
  <verify>
```bash
cd /tmp/rachel-cloud && node -e "
process.env.DATABASE_URL = 'postgresql://user:pass@localhost:5432/testdb';
process.env.GOOGLE_CLIENT_ID = 'test';
process.env.GOOGLE_CLIENT_SECRET = 'test';
const { auth } = require('./src/auth/config.ts');
console.assert(auth.handler !== undefined, 'Auth handler missing');
console.log('✓ Better Auth configured');
"
```
Better Auth instance created successfully with all providers
  </verify>
  <done>
Better Auth configured with Drizzle adapter, email/password authentication, Google OAuth, and session management
  </done>
</task>

</tasks>

<verification>
1. Run database migrations: `bun run drizzle-kit push` succeeds
2. Verify schema: `bun run drizzle-kit studio` shows users, sessions, accounts tables
3. Test encryption: TokenEncryption class encrypts/decrypts test tokens without errors
4. Check Better Auth: auth instance exports handler function and accepts requests
5. Validate environment setup: All required env vars documented in user_setup section
</verification>

<success_criteria>
- Database schema exists with users, sessions, and accounts tables
- Token encryption class performs AES-256-GCM encryption/decryption successfully
- Better Auth is configured with Drizzle adapter and Google OAuth
- All dependencies installed and importable without errors
- Environment variables are documented and validated during initialization
- Requirements AUTH-05 (encrypted token storage) foundation is established
</success_criteria>

<output>
After completion, create `.planning/phases/01-authentication-user-foundation/01-01-SUMMARY.md` documenting:
- Database schema structure and migration status
- Better Auth configuration and enabled providers
- Token encryption implementation details
- Environment variables required for next plans
- Any deviations from research or issues encountered
</output>
