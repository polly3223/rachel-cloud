---
phase: 01-authentication-user-foundation
plan: 03
type: execute
wave: 2
depends_on: ["01-01"]
files_modified:
  - src/lib/auth/claude-oauth.ts
  - src/routes/api/claude/connect/+server.ts
  - src/routes/api/claude/callback/+server.ts
  - src/routes/api/claude/refresh/+server.ts
  - src/routes/dashboard/claude/+page.svelte
  - src/routes/dashboard/claude/+page.server.ts
  - package.json
autonomous: true
user_setup:
  - service: claude-oauth
    why: "Claude OAuth 2.0 integration for user authentication"
    env_vars:
      - name: CLAUDE_CLIENT_ID
        source: "Claude dashboard (when available) or use reference from github.com/grll/claude-code-login"
      - name: CLAUDE_CLIENT_SECRET
        source: "Claude dashboard (when available) or use reference from github.com/grll/claude-code-login"
    dashboard_config:
      - task: "Register OAuth application with Anthropic"
        location: "Claude console (follow claude-code-login pattern)"
      - task: "Set redirect URI to: http://localhost:5173/api/claude/callback"
        location: "OAuth app settings"

must_haves:
  truths:
    - "User can initiate Claude OAuth flow from dashboard"
    - "User is redirected to Claude authorization page"
    - "OAuth callback exchanges code for tokens using PKCE"
    - "Claude access and refresh tokens are encrypted before storage"
    - "Tokens are automatically refreshed when expired"
  artifacts:
    - path: "src/lib/auth/claude-oauth.ts"
      provides: "Claude OAuth 2.0 + PKCE client implementation"
      exports: ["generateAuthUrl", "exchangeCode", "refreshToken"]
      min_lines: 80
    - path: "src/routes/api/claude/connect/+server.ts"
      provides: "Initiates Claude OAuth flow with PKCE"
      exports: ["GET"]
      min_lines: 30
    - path: "src/routes/api/claude/callback/+server.ts"
      provides: "Handles OAuth callback and stores encrypted tokens"
      exports: ["GET"]
      min_lines: 50
    - path: "src/routes/api/claude/refresh/+server.ts"
      provides: "Token refresh endpoint"
      exports: ["POST"]
      min_lines: 40
    - path: "src/routes/dashboard/claude/+page.svelte"
      provides: "Claude connection UI"
      min_lines: 50
  key_links:
    - from: "src/lib/auth/claude-oauth.ts"
      to: "src/lib/crypto/encryption.ts"
      via: "imports encryptToken/decryptToken"
      pattern: "import.*encrypt.*from.*crypto"
    - from: "src/routes/api/claude/callback/+server.ts"
      to: "src/lib/db/schema.ts"
      via: "inserts into claudeTokens table"
      pattern: "db\\.insert.*claudeTokens"
    - from: "src/routes/api/claude/refresh/+server.ts"
      to: "src/lib/auth/claude-oauth.ts"
      via: "calls refreshToken function"
      pattern: "refreshToken\\("
---

<objective>
Implement Claude OAuth 2.0 + PKCE flow with encrypted token storage and auto-refresh.

Purpose: Enable users to securely connect their Claude account via OAuth 2.0 with PKCE, store tokens encrypted with AES-256-GCM, and automatically refresh tokens when they expire. This is the core of AUTH-04, AUTH-05, and AUTH-06 requirements.

Output: Working Claude OAuth integration that allows users to authenticate with their Claude account, with tokens securely encrypted in the database and automatically refreshed.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@/tmp/rachel-cloud/.planning/PROJECT.md
@/tmp/rachel-cloud/.planning/ROADMAP.md
@/tmp/rachel-cloud/.planning/phases/01-authentication-user-foundation/01-CONTEXT.md
@/tmp/rachel-cloud/.planning/phases/01-authentication-user-foundation/01-01-SUMMARY.md

Reference implementation:
- github.com/grll/claude-code-login (open-source Claude OAuth + PKCE implementation)
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement Claude OAuth 2.0 + PKCE client</name>
  <files>
    src/lib/auth/claude-oauth.ts
    package.json
  </files>
  <action>
Install PKCE library:
- Run `bun add pkce-challenge` for PKCE code verifier/challenge generation

**src/lib/auth/claude-oauth.ts:**
Reference: github.com/grll/claude-code-login for Claude OAuth endpoints and flow

- Import `pkceChallenge` from "pkce-challenge"
- Import `encryptToken`, `decryptToken` from lib/crypto/encryption
- Define Claude OAuth configuration:
  - authorizationEndpoint: "https://claude.ai/oauth/authorize" (verify with claude-code-login)
  - tokenEndpoint: "https://claude.ai/oauth/token" (verify with claude-code-login)
  - clientId: process.env.CLAUDE_CLIENT_ID
  - clientSecret: process.env.CLAUDE_CLIENT_SECRET
  - redirectUri: process.env.PUBLIC_BASE_URL + "/api/claude/callback"

- Implement `generateAuthUrl()`:
  - Generate PKCE challenge using pkceChallenge()
  - Store code_verifier in session/cookie (temporary, 5 min expiry)
  - Build authorization URL with: client_id, redirect_uri, response_type=code, code_challenge, code_challenge_method=S256, scope (if needed)
  - Return { authUrl, codeVerifier }

- Implement `exchangeCode(code: string, codeVerifier: string)`:
  - POST to tokenEndpoint with:
    - grant_type: "authorization_code"
    - code
    - redirect_uri
    - client_id
    - client_secret
    - code_verifier (for PKCE)
  - Parse response: { access_token, refresh_token, expires_in }
  - Return tokens object

- Implement `refreshToken(refreshToken: string)`:
  - POST to tokenEndpoint with:
    - grant_type: "refresh_token"
    - refresh_token
    - client_id
    - client_secret
  - Parse response: { access_token, refresh_token, expires_in }
  - Return new tokens

Export all three functions.
  </action>
  <verify>
Create a test script that calls generateAuthUrl() and verifies it returns a valid Claude authorization URL with PKCE challenge. Manually inspect URL structure to ensure all required OAuth 2.0 + PKCE parameters are present.
  </verify>
  <done>
Claude OAuth 2.0 + PKCE client implemented with generateAuthUrl, exchangeCode, and refreshToken functions, PKCE challenge generation working, all OAuth endpoints configured per claude-code-login reference.
  </done>
</task>

<task type="auto">
  <name>Task 2: Create OAuth initiation and callback endpoints</name>
  <files>
    src/routes/api/claude/connect/+server.ts
    src/routes/api/claude/callback/+server.ts
  </files>
  <action>
**src/routes/api/claude/connect/+server.ts:**
- Import `generateAuthUrl` from lib/auth/claude-oauth
- Import `requireAuth` from lib/auth/session
- Export GET handler:
  - Call requireAuth(event) to ensure user is logged in
  - Call generateAuthUrl() to get authUrl and codeVerifier
  - Store codeVerifier in encrypted cookie (name: "pkce_verifier", httpOnly: true, secure: true in prod, maxAge: 5 minutes)
  - Redirect user to authUrl

**src/routes/api/claude/callback/+server.ts:**
- Import `exchangeCode` from lib/auth/claude-oauth
- Import `encryptToken` from lib/crypto/encryption
- Import `db` and `claudeTokens` from lib/db
- Import `requireAuth` from lib/auth/session
- Export GET handler:
  - Call requireAuth(event) to get current user
  - Extract `code` from query params
  - Retrieve codeVerifier from encrypted cookie
  - If no codeVerifier, return 400 error (PKCE flow incomplete)
  - Call exchangeCode(code, codeVerifier)
  - Encrypt access_token and refresh_token using encryptToken()
  - Calculate expiresAt timestamp (now + expires_in seconds)
  - Insert/update claudeTokens record:
    - userId: session.user.id
    - encryptedAccessToken
    - encryptedRefreshToken
    - expiresAt
    - createdAt, updatedAt
  - Clear pkce_verifier cookie
  - Redirect to /dashboard/claude with success message
  - Handle errors: invalid code, expired verifier, network failures
  </action>
  <verify>
Test OAuth flow end-to-end:
1. Log in as a user
2. Visit /api/claude/connect and verify redirect to Claude authorization page
3. Authorize and verify callback to /api/claude/callback
4. Check database with `bun run drizzle-kit studio` and verify claudeTokens record exists with encrypted tokens
5. Attempt to decrypt stored tokens manually and verify they match expected format
  </verify>
  <done>
Claude OAuth flow works end-to-end, user can initiate connection from dashboard, PKCE flow completes successfully, tokens are encrypted with AES-256-GCM before storage, callback handles all error cases gracefully.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement auto-refresh mechanism and connection UI</name>
  <files>
    src/routes/api/claude/refresh/+server.ts
    src/routes/dashboard/claude/+page.svelte
    src/routes/dashboard/claude/+page.server.ts
    src/lib/auth/claude-token-manager.ts
  </files>
  <action>
**src/lib/auth/claude-token-manager.ts:**
- Import `db`, `claudeTokens` from lib/db
- Import `refreshToken` from lib/auth/claude-oauth
- Import `encryptToken`, `decryptToken` from lib/crypto/encryption
- Implement `getValidToken(userId: string)`:
  - Fetch claudeTokens record for userId
  - If not found, return null
  - Check if token is expired (expiresAt < now)
  - If expired:
    - Decrypt refresh_token
    - Call refreshToken(refresh_token)
    - Encrypt new tokens
    - Update claudeTokens record
  - Decrypt and return valid access_token
- Export getValidToken

**src/routes/api/claude/refresh/+server.ts:**
- Import `requireAuth` from lib/auth/session
- Import `getValidToken` from lib/auth/claude-token-manager
- Export POST handler:
  - Call requireAuth(event) to get user
  - Call getValidToken(userId)
  - If successful, return { success: true, expiresAt }
  - If failed, return { success: false, error }

**src/routes/dashboard/claude/+page.server.ts:**
- Import `requireAuth` from lib/auth/session
- Import `db`, `claudeTokens` from lib/db
- Export load function:
  - Call requireAuth(event)
  - Fetch claudeTokens record for current user
  - Return { connected: !!record, expiresAt: record?.expiresAt }

**src/routes/dashboard/claude/+page.svelte:**
- Import page data from load function
- If not connected:
  - Display "Connect Claude Account" button
  - On click, redirect to /api/claude/connect
  - Show explanation of why Claude connection is needed
- If connected:
  - Display "Claude Connected" status with green checkmark
  - Show token expiry timestamp
  - Add "Disconnect" button (deletes claudeTokens record)
  - Add "Refresh Token" button (calls /api/claude/refresh)
- Use Tailwind CSS for clean UI
  </action>
  <verify>
Test auto-refresh mechanism:
1. Manually set expiresAt in database to a past timestamp
2. Call getValidToken(userId) and verify it auto-refreshes
3. Check database and confirm expiresAt is now in the future
4. Visit /dashboard/claude and verify UI shows "Connected" status
5. Click "Refresh Token" and verify it completes without errors
6. Test disconnect flow and verify token is removed from database
  </verify>
  <done>
Token auto-refresh works automatically when tokens expire, getValidToken() handles refresh transparently, dashboard shows Claude connection status, users can connect/disconnect/refresh tokens via UI, all token operations use encrypted storage.
  </done>
</task>

</tasks>

<verification>
1. Complete full Claude OAuth flow from initiation to callback
2. Verify tokens are encrypted in database (raw values should be base64 gibberish)
3. Decrypt stored tokens manually and verify they're valid access/refresh tokens
4. Test auto-refresh by expiring a token and calling getValidToken()
5. Visit /dashboard/claude when not connected and verify "Connect" button appears
6. Visit /dashboard/claude when connected and verify "Connected" status with expiry
7. Test PKCE security: attempt callback without valid code_verifier and verify it fails
</verification>

<success_criteria>
- Users can initiate Claude OAuth flow and complete authorization
- OAuth callback exchanges authorization code for tokens using PKCE
- Access and refresh tokens are encrypted with AES-256-GCM before database storage
- Tokens auto-refresh when expired without user intervention
- Dashboard UI shows Claude connection status clearly
- PKCE flow prevents authorization code interception attacks
- All error cases handled gracefully with user-friendly messages
</success_criteria>

<output>
After completion, create `.planning/phases/01-authentication-user-foundation/01-03-SUMMARY.md`
</output>
