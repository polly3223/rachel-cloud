---
phase: 02-billing-onboarding
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - src/lib/db/schema.ts
  - drizzle.config.ts
  - src/lib/billing/polar-client.ts
  - src/lib/auth/config.ts
  - package.json
autonomous: true
user_setup:
  - service: polar
    why: "Payment processing and subscription management"
    env_vars:
      - name: POLAR_ACCESS_TOKEN
        source: "Polar Dashboard -> Settings -> API Keys"
      - name: POLAR_PRODUCT_ID
        source: "Polar Dashboard -> Products -> Create Product ($20/month) -> Copy Product ID"
      - name: POLAR_WEBHOOK_SECRET
        source: "Polar Dashboard -> Webhooks -> Create Endpoint -> Copy Signing Secret"
      - name: POLAR_MODE
        source: "Set to 'sandbox' for dev, 'production' for live"
    dashboard_config:
      - task: "Create $20/month subscription product"
        location: "Polar Dashboard -> Products -> Create Product"
      - task: "Configure webhook endpoint"
        location: "Polar Dashboard -> Webhooks -> Add endpoint URL (will be set up in Plan 02-02)"

must_haves:
  truths:
    - "Database tracks user subscription status (active, grace_period, canceled)"
    - "Database stores Polar customer IDs linked to users"
    - "Database can track Telegram bot tokens (encrypted) per user"
    - "Polar SDK is configured and can authenticate with API"
    - "Better Auth is integrated with Polar plugin for auto-customer creation"
  artifacts:
    - path: "src/lib/db/schema.ts"
      provides: "subscriptions, telegramBots tables"
      contains: "sqliteTable('subscriptions'"
    - path: "src/lib/billing/polar-client.ts"
      provides: "Polar SDK initialization"
      exports: ["polarClient"]
    - path: "src/lib/auth/config.ts"
      provides: "Polar plugin integration with Better Auth"
      contains: "@polar-sh/better-auth"
    - path: "package.json"
      provides: "Polar dependencies installed"
      contains: "@polar-sh/sdk"
  key_links:
    - from: "src/lib/auth/config.ts"
      to: "src/lib/billing/polar-client.ts"
      via: "polar plugin imports polarClient"
      pattern: "import.*polarClient.*from.*polar-client"
    - from: "src/lib/db/schema.ts"
      to: "subscriptions.userId"
      via: "foreign key to users table"
      pattern: "references.*users\\.id"
---

<objective>
Extend database schema for billing and onboarding, integrate Polar SDK with Better Auth for automatic customer creation on signup.

Purpose: Establish the billing and onboarding data model, and integrate the payment provider (Polar) with authentication so that every signup automatically creates a Polar customer ready for subscription checkout.

Output: Database schema supporting subscriptions and Telegram bot storage, Polar SDK configured and integrated via Better Auth plugin with auto-customer creation enabled.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/REQUIREMENTS.md
@.planning/phases/02-billing-onboarding/02-CONTEXT.md
@.planning/phases/02-billing-onboarding/02-RESEARCH.md
@.planning/phases/01-authentication-user-foundation/01-01-SUMMARY.md
@/tmp/rachel-cloud/src/lib/db/schema.ts
@/tmp/rachel-cloud/src/lib/auth/config.ts
@/tmp/rachel-cloud/src/lib/crypto/encryption.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Extend database schema with subscriptions and telegramBots tables</name>
  <files>
    src/lib/db/schema.ts
  </files>
  <action>
Add two new tables to the existing schema:

**subscriptions table:**
- id: text (UUID primary key)
- userId: text (foreign key to users.id, unique, cascade delete)
- polarCustomerId: text (Polar customer ID, nullable initially)
- polarSubscriptionId: text (Polar subscription ID, nullable)
- status: text (enum: 'none', 'active', 'grace_period', 'canceled')
- currentPeriodEnd: integer timestamp (next billing date, nullable)
- gracePeriodEndsAt: integer timestamp (3-day grace period end, nullable)
- vpsProvisioned: integer boolean (default false)
- createdAt: integer timestamp
- updatedAt: integer timestamp

**telegramBots table:**
- id: text (UUID primary key)
- userId: text (foreign key to users.id, unique, cascade delete)
- botUsername: text (Telegram bot username, nullable)
- encryptedToken: text (AES-256-GCM encrypted bot token)
- validated: integer boolean (default false)
- createdAt: integer timestamp
- updatedAt: integer timestamp

Use the same patterns from existing schema (sqliteTable, integer timestamps with mode: 'timestamp', $defaultFn, $onUpdateFn, references with onDelete: 'cascade').

Export both tables at the end of the file.
  </action>
  <verify>
Run drizzle-kit to validate and push schema:
```bash
cd /tmp/rachel-cloud && bunx drizzle-kit push
```

Check that both tables are created in SQLite database:
```bash
bun -e "import {Database} from 'bun:sqlite'; const db = new Database('data/rachel-cloud.db'); console.log(db.query('SELECT name FROM sqlite_master WHERE type=\"table\"').all())"
```
  </verify>
  <done>
Schema includes subscriptions and telegramBots tables with correct foreign keys, indexes, and encryption support for bot tokens. Database migration applied successfully.
  </done>
</task>

<task type="auto">
  <name>Task 2: Install Polar dependencies and initialize Polar SDK client</name>
  <files>
    package.json
    src/lib/billing/polar-client.ts
  </files>
  <action>
Install Polar packages:
```bash
cd /tmp/rachel-cloud && bun add @polar-sh/better-auth @polar-sh/sdk
```

Create `src/lib/billing/polar-client.ts`:
- Import Polar from '@polar-sh/sdk'
- Read environment variables: POLAR_ACCESS_TOKEN (required), POLAR_MODE (default: 'sandbox')
- Initialize Polar client with accessToken and server mode (production vs sandbox)
- Export polarClient as singleton
- Include error handling if POLAR_ACCESS_TOKEN is missing (throw with clear message)

Pattern based on RESEARCH.md Architecture Pattern 1:
```typescript
import { Polar } from "@polar-sh/sdk";

if (!process.env.POLAR_ACCESS_TOKEN) {
  throw new Error('POLAR_ACCESS_TOKEN environment variable is required');
}

export const polarClient = new Polar({
  accessToken: process.env.POLAR_ACCESS_TOKEN,
  server: process.env.POLAR_MODE === 'production' ? 'production' : 'sandbox'
});
```
  </action>
  <verify>
Verify TypeScript compiles without errors:
```bash
cd /tmp/rachel-cloud && bun run check
```

Verify polar-client.ts can be imported (will fail without env var, expected):
```bash
cd /tmp/rachel-cloud && bun -e "try { const { polarClient } = await import('./src/lib/billing/polar-client.ts'); console.log('Polar client type:', typeof polarClient); } catch (e) { if (e.message.includes('POLAR_ACCESS_TOKEN')) { console.log('✓ Correctly requires POLAR_ACCESS_TOKEN'); } else { throw e; } }"
```
  </verify>
  <done>
Polar SDK packages installed, polar-client.ts created with proper initialization and environment validation. TypeScript compilation passes.
  </done>
</task>

<task type="auto">
  <name>Task 3: Integrate Polar plugin with Better Auth for auto-customer creation</name>
  <files>
    src/lib/auth/config.ts
  </files>
  <action>
Update Better Auth configuration to integrate the Polar plugin:

1. Import polar plugin components from '@polar-sh/better-auth':
   - polar (main plugin)
   - checkout, portal, webhooks (sub-plugins)

2. Import polarClient from '$lib/billing/polar-client'

3. Add polar plugin to Better Auth plugins array with:
   - client: polarClient
   - createCustomerOnSignUp: true (CRITICAL - auto-creates Polar customer on user signup)
   - use: [checkout(), portal(), webhooks()] sub-plugins

4. Configure checkout sub-plugin:
   - products: [{ productId: process.env.POLAR_PRODUCT_ID!, slug: "rachel-cloud-monthly" }]
   - successUrl: "/onboarding?checkout_id={CHECKOUT_ID}"
   - authenticatedUsersOnly: true

5. Configure webhooks sub-plugin with secret from env:
   - secret: process.env.POLAR_WEBHOOK_SECRET!
   - Stub handlers for now (will be implemented in Plan 02-02):
     - onSubscriptionActive: async (payload) => { console.log('TODO: Handle subscription active') }
     - onSubscriptionCanceled: async (payload) => { console.log('TODO: Handle subscription canceled') }
     - onSubscriptionRevoked: async (payload) => { console.log('TODO: Handle subscription revoked') }
     - onPaymentFailed: async (payload) => { console.log('TODO: Handle payment failed') }

Follow RESEARCH.md Architecture Pattern 1 structure exactly. Use LOCKED decision from CONTEXT.md: Polar (NOT Stripe), Better Auth plugin integration.
  </action>
  <verify>
Verify Better Auth config compiles and polar plugin is loaded:
```bash
cd /tmp/rachel-cloud && bun run check
```

Check that auth exports include polar methods:
```bash
cd /tmp/rachel-cloud && bun -e "const { auth } = await import('./src/lib/auth/config.ts'); console.log('Auth object keys:', Object.keys(auth).slice(0, 10)); console.log('✓ Better Auth with Polar plugin loaded');" 2>&1 | grep -q "Better Auth" && echo "✓ Verification passed"
```
  </verify>
  <done>
Better Auth is integrated with Polar plugin, automatic customer creation enabled on signup, checkout and portal sub-plugins configured. Webhook handlers stubbed for Plan 02-02 implementation.
  </done>
</task>

</tasks>

<verification>
1. Run `bunx drizzle-kit push` and confirm subscriptions + telegramBots tables exist
2. Run `bun run check` and verify TypeScript compilation with no errors
3. Verify polar-client.ts exports polarClient singleton
4. Verify Better Auth config includes polar plugin with createCustomerOnSignUp: true
5. Verify package.json includes @polar-sh/better-auth and @polar-sh/sdk dependencies
</verification>

<success_criteria>
1. Database schema includes subscriptions table tracking status (active/grace_period/canceled) and Polar IDs
2. Database schema includes telegramBots table with encrypted token storage
3. Polar SDK is initialized and configured to use sandbox/production mode from env vars
4. Better Auth polar plugin is integrated with auto-customer creation enabled
5. All TypeScript types resolve correctly and bun run check passes
6. User setup instructions are documented for Polar dashboard configuration
</success_criteria>

<output>
After completion, create `.planning/phases/02-billing-onboarding/02-01-SUMMARY.md` using the summary template.
</output>
