---
phase: 02-billing-onboarding
plan: 02
type: execute
wave: 2
depends_on: [02-01]
files_modified:
  - src/lib/auth/config.ts
  - src/lib/billing/subscription-manager.ts
  - src/lib/jobs/grace-period-enforcer.ts
  - src/lib/email/sender.ts
  - src/lib/email/templates/payment-failed.svelte
  - src/routes/api/billing/cancel/+server.ts
  - package.json
autonomous: true
user_setup:
  - service: resend
    why: "Transactional email notifications for payment failures"
    env_vars:
      - name: RESEND_API_KEY
        source: "Resend Dashboard -> API Keys -> Create API Key"
      - name: RESEND_FROM_EMAIL
        source: "Your verified domain email (e.g., 'Rachel Cloud <noreply@rachel.cloud>')"

must_haves:
  truths:
    - "Polar webhooks update subscription status in database automatically"
    - "Canceled subscriptions trigger 3-day grace period countdown"
    - "Grace period job deprovisions VPS after 3 days if not recovered"
    - "Payment failures send email notification to user"
    - "User can cancel subscription from API endpoint"
  artifacts:
    - path: "src/lib/auth/config.ts"
      provides: "Webhook handlers for subscription lifecycle"
      contains: "onSubscriptionActive"
    - path: "src/lib/billing/subscription-manager.ts"
      provides: "Database operations for subscription state"
      exports: ["updateSubscriptionStatus", "scheduleGracePeriod"]
    - path: "src/lib/jobs/grace-period-enforcer.ts"
      provides: "Scheduled job for VPS deprovisioning"
      exports: ["scheduleGracePeriodDeprovision", "cancelGracePeriodJob"]
    - path: "src/lib/email/sender.ts"
      provides: "Email sending via Resend"
      exports: ["sendPaymentFailedEmail"]
    - path: "src/routes/api/billing/cancel/+server.ts"
      provides: "User-initiated subscription cancellation"
      exports: ["POST"]
  key_links:
    - from: "src/lib/auth/config.ts"
      to: "src/lib/billing/subscription-manager.ts"
      via: "webhook handlers call subscription manager"
      pattern: "updateSubscriptionStatus|scheduleGracePeriod"
    - from: "src/lib/jobs/grace-period-enforcer.ts"
      to: "subscriptions table"
      via: "updates vpsProvisioned status"
      pattern: "db\\.update\\(subscriptions\\)"
---

<objective>
Implement Polar webhook handlers for subscription lifecycle, grace period logic with scheduled deprovisioning, and email notifications for payment failures.

Purpose: Complete the billing integration by handling subscription state changes from Polar webhooks, enforcing the 3-day grace period when subscriptions are canceled, and notifying users of payment failures. This ensures the system stays in sync with Polar and enforces business rules around subscription lifecycle.

Output: Fully functional webhook handlers updating database state, grace period jobs scheduling VPS deprovisioning after 3 days, email notifications on payment failures, and user-initiated cancellation endpoint.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-billing-onboarding/02-CONTEXT.md
@.planning/phases/02-billing-onboarding/02-RESEARCH.md
@/tmp/rachel-cloud/src/lib/db/schema.ts
@/tmp/rachel-cloud/src/lib/auth/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Implement subscription manager and webhook handlers</name>
  <files>
    src/lib/billing/subscription-manager.ts
    src/lib/auth/config.ts
  </files>
  <action>
Create `src/lib/billing/subscription-manager.ts` with database operations:

1. Import db and subscriptions schema from '$lib/db'
2. Import eq from 'drizzle-orm'
3. Implement `updateSubscriptionStatus()`:
   - Parameters: userId, polarCustomerId, polarSubscriptionId, status, currentPeriodEnd
   - Updates or inserts subscription record
   - Use db.insert().values().onConflictDoUpdate() pattern for upsert

4. Implement `getSubscription()`:
   - Parameter: userId
   - Returns subscription record or null

5. Implement `scheduleGracePeriod()`:
   - Parameters: userId, subscriptionId
   - Calculates gracePeriodEndsAt = now + 3 days
   - Updates subscription status to 'grace_period' with gracePeriodEndsAt timestamp
   - Returns gracePeriodEndsAt date

Update `src/lib/auth/config.ts` webhook handlers (replace console.log stubs):

**onSubscriptionActive handler:**
- Call updateSubscriptionStatus() with status: 'active', clear gracePeriodEndsAt
- Log subscription activation

**onSubscriptionCanceled handler:**
- Call scheduleGracePeriod() to set 3-day countdown
- Import and call scheduleGracePeriodDeprovision() from grace-period-enforcer (will be created in Task 2)

**onSubscriptionRevoked handler:**
- Update subscription status to 'canceled'
- Set vpsProvisioned: false immediately (no grace period for revoked)

**onPaymentFailed handler:**
- Import and call sendPaymentFailedEmail() (will be created in Task 3)
- Log payment failure

**onSubscriptionUncanceled handler (CRITICAL - prevents grace period data loss):**
- Cancel scheduled grace period job via cancelGracePeriodJob()
- Update subscription status back to 'active', clear gracePeriodEndsAt
- Per RESEARCH.md Common Pitfall 3

Use webhook payload types from @polar-sh/better-auth. Handle errors gracefully (try/catch, log errors, don't throw - webhook must return 200).
  </action>
  <verify>
Verify TypeScript compilation:
```bash
cd /tmp/rachel-cloud && bun run check
```

Test subscription manager functions in isolation:
```bash
cd /tmp/rachel-cloud && bun -e "
import { updateSubscriptionStatus } from './src/lib/billing/subscription-manager.ts';
console.log('✓ Subscription manager exports loaded');
"
```
  </verify>
  <done>
Subscription manager implements database operations for subscription state management. Webhook handlers update database on subscription lifecycle events (active, canceled, revoked, uncanceled, payment failed). Error handling prevents webhook failures from breaking sync.
  </done>
</task>

<task type="auto">
  <name>Task 2: Implement grace period scheduling with node-schedule</name>
  <files>
    package.json
    src/lib/jobs/grace-period-enforcer.ts
  </files>
  <action>
Install node-schedule:
```bash
cd /tmp/rachel-cloud && bun add node-schedule && bun add -d @types/node-schedule
```

Create `src/lib/jobs/grace-period-enforcer.ts` implementing RESEARCH.md Architecture Pattern 4:

1. Import schedule from 'node-schedule'
2. Import db, subscriptions from '$lib/db'
3. Import eq from 'drizzle-orm'

4. Implement `scheduleGracePeriodDeprovision()`:
   - Parameters: userId, subscriptionId
   - Calculate gracePeriodEnd = new Date() + 3 days
   - Update subscription in DB: status = 'grace_period', gracePeriodEndsAt = gracePeriodEnd
   - Schedule job using schedule.scheduleJob(`deprovision-${userId}`, gracePeriodEnd, async callback)
   - Callback logic:
     a. Query subscription status
     b. If status is still 'grace_period' (not recovered):
        - Call deprovisionVPS() stub: `async function deprovisionVPS(userId: string) { console.log('TODO Phase 3: Deprovision VPS for', userId); }`
        - Update subscription: status = 'canceled', vpsProvisioned = false
     c. If status is 'active' (recovered), do nothing (job should have been canceled)
   - Return scheduled job

5. Implement `cancelGracePeriodJob()`:
   - Parameter: userId
   - Get job from schedule.scheduledJobs[`deprovision-${userId}`]
   - If exists, call job.cancel()
   - Return boolean (was job canceled)

6. Add deprovisionVPS stub at bottom of file (Phase 3 will implement):
   ```typescript
   async function deprovisionVPS(userId: string) {
     console.log('TODO Phase 3: Deprovision VPS for user', userId);
     // Phase 3 will implement Hetzner API calls here
   }
   ```

Include CRITICAL safeguard from RESEARCH.md Pitfall 3: Check subscription status before deprovisioning in case subscription was uncanceled.
  </action>
  <verify>
Verify TypeScript compilation:
```bash
cd /tmp/rachel-cloud && bun run check
```

Test grace period job scheduling in isolation:
```bash
cd /tmp/rachel-cloud && bun -e "
import { scheduleGracePeriodDeprovision, cancelGracePeriodJob } from './src/lib/jobs/grace-period-enforcer.ts';
const testDate = new Date(Date.now() + 5000); // 5 seconds from now
console.log('✓ Grace period enforcer exports loaded');
"
```
  </verify>
  <done>
Grace period enforcer schedules VPS deprovisioning 3 days after subscription cancellation. Cancellation handler clears scheduled jobs on subscription recovery. Deprovisioning stub prepared for Phase 3 implementation.
  </done>
</task>

<task type="auto">
  <name>Task 3: Implement email notifications with Resend and Svelte Email</name>
  <files>
    package.json
    src/lib/email/sender.ts
    src/lib/email/templates/payment-failed.svelte
    src/routes/api/billing/cancel/+server.ts
  </files>
  <action>
Install email dependencies:
```bash
cd /tmp/rachel-cloud && bun add resend svelte-email
```

Create `src/lib/email/sender.ts` following RESEARCH.md Code Examples:
1. Import Resend from 'resend'
2. Initialize: `const resend = new Resend(process.env.RESEND_API_KEY)`
3. Implement `sendPaymentFailedEmail(userEmail: string, userName: string)`:
   - Parameters: userEmail, userName
   - Call resend.emails.send() with:
     - from: process.env.RESEND_FROM_EMAIL || 'Rachel Cloud <noreply@rachel.cloud>'
     - to: userEmail
     - subject: 'Payment Failed - Update Your Payment Method'
     - html: Simple template with user greeting, payment failed message, link to /dashboard/billing
   - Wrap in try/catch, log errors, don't throw (email failure shouldn't break webhook)
   - Return boolean success status

Create `src/lib/email/templates/payment-failed.svelte`:
- Simple Svelte component with HTML email structure
- Props: userName (string)
- Content: Greeting, payment failed notice, CTA button to update payment method
- Keep minimal for now (svelte-email setup is for future enhancement)

Create `src/routes/api/billing/cancel/+server.ts` for user-initiated cancellation (BILL-03):
1. Export POST handler
2. Get session from event.locals.session (Better Auth pattern)
3. If no session, return 401 Unauthorized
4. Import polarClient from '$lib/billing/polar-client'
5. Get user's subscription from database via subscription-manager
6. Call polarClient.subscriptions.cancel() with subscriptionId
7. Return 200 with success message
8. Wrap in try/catch, return 500 on error

Follow RESEARCH.md LOCKED decision: Resend for email (NOT Nodemailer). Use pattern from Code Examples section.
  </action>
  <verify>
Verify TypeScript compilation:
```bash
cd /tmp/rachel-cloud && bun run check
```

Test email sender exports load:
```bash
cd /tmp/rachel-cloud && bun -e "
import { sendPaymentFailedEmail } from './src/lib/email/sender.ts';
console.log('✓ Email sender exports loaded');
"
```

Test billing cancel endpoint exists:
```bash
cd /tmp/rachel-cloud && ls src/routes/api/billing/cancel/+server.ts && echo "✓ Cancel endpoint created"
```
  </verify>
  <done>
Email sender implements payment failure notifications via Resend. Svelte email template created for future enhancement. User-initiated subscription cancellation endpoint implemented with Polar API integration. All error handling in place to prevent webhook failures.
  </done>
</task>

</tasks>

<verification>
1. Run `bun run check` and verify TypeScript compilation with no errors
2. Verify subscription-manager.ts exports updateSubscriptionStatus and scheduleGracePeriod
3. Verify grace-period-enforcer.ts schedules jobs with node-schedule
4. Verify email/sender.ts uses Resend API correctly
5. Verify webhook handlers in auth/config.ts call subscription manager functions
6. Verify api/billing/cancel endpoint exists and uses polarClient
</verification>

<success_criteria>
1. Polar webhooks successfully update subscription status in database
2. Subscription cancellation schedules grace period job 3 days in future
3. Grace period job stub logs deprovisioning action (actual VPS teardown in Phase 3)
4. Payment failure webhook sends email notification via Resend
5. User can cancel subscription via POST to /api/billing/cancel
6. Subscription uncanceled event cancels scheduled grace period job (prevents data loss)
7. All webhook handlers include error handling and don't throw (always return 200)
</success_criteria>

<output>
After completion, create `.planning/phases/02-billing-onboarding/02-02-SUMMARY.md` using the summary template.
</output>
