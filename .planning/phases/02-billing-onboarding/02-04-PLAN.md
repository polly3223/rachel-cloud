---
phase: 02-billing-onboarding
plan: 04
type: execute
wave: 3
depends_on: [02-02, 02-03]
files_modified:
  - src/routes/dashboard/billing/+page.svelte
  - src/routes/dashboard/billing/+page.server.ts
  - src/lib/auth/client.ts
  - src/routes/dashboard/+layout.svelte
autonomous: false

must_haves:
  truths:
    - "User can view subscription status (active/grace_period/canceled)"
    - "User can see next billing date for active subscriptions"
    - "User can cancel subscription with confirmation"
    - "User can access Polar customer portal to update payment method"
    - "Dashboard is protected by authentication"
  artifacts:
    - path: "src/routes/dashboard/billing/+page.svelte"
      provides: "Billing dashboard UI"
      min_lines: 80
    - path: "src/routes/dashboard/billing/+page.server.ts"
      provides: "Subscription data loading"
      exports: ["load"]
    - path: "src/lib/auth/client.ts"
      provides: "Better Auth client for frontend"
      exports: ["authClient"]
    - path: "src/routes/dashboard/+layout.svelte"
      provides: "Dashboard layout with navigation"
      min_lines: 30
  key_links:
    - from: "src/routes/dashboard/billing/+page.svelte"
      to: "src/lib/auth/client.ts"
      via: "calls authClient.customer.portal()"
      pattern: "authClient\\.customer\\.portal"
    - from: "src/routes/dashboard/billing/+page.svelte"
      to: "/api/billing/cancel"
      via: "fetch POST on cancel button"
      pattern: "fetch.*billing/cancel.*POST"
    - from: "src/routes/dashboard/billing/+page.server.ts"
      to: "subscriptions table"
      via: "loads user subscription data"
      pattern: "db\\.query\\.subscriptions"
---

<objective>
Build billing dashboard UI allowing users to view subscription status, manage payment methods via Polar customer portal, and cancel subscriptions.

Purpose: Provide users with visibility and control over their subscription, meeting requirements BILL-02 (view status/billing date) and BILL-03 (cancel subscription). Dashboard serves as central hub for subscription management.

Output: Billing dashboard page with subscription status display, Polar customer portal integration, cancellation flow with confirmation, and protected dashboard layout.
</objective>

<execution_context>
@/home/rachel/.claude/get-shit-done/workflows/execute-plan.md
@/home/rachel/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/02-billing-onboarding/02-CONTEXT.md
@.planning/phases/02-billing-onboarding/02-RESEARCH.md
@/tmp/rachel-cloud/src/lib/db/schema.ts
@/tmp/rachel-cloud/src/lib/auth/config.ts
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Better Auth client and dashboard layout</name>
  <files>
    src/lib/auth/client.ts
    src/routes/dashboard/+layout.svelte
    src/routes/dashboard/+layout.server.ts
  </files>
  <action>
Create `src/lib/auth/client.ts` for frontend auth operations:
1. Import createAuthClient from '@better-auth/svelte' (or 'better-auth/client' if no Svelte-specific package)
2. Initialize authClient with Better Auth config:
   ```typescript
   import { createAuthClient } from 'better-auth/svelte-client';
   export const authClient = createAuthClient({
     baseURL: '/api/auth'
   });
   ```
3. Export authClient singleton
4. Note: Better Auth Polar plugin methods (checkout, customer.portal, customer.state) will be available on authClient

Create `src/routes/dashboard/+layout.server.ts`:
1. Implement load function to check authentication
2. Get session from event.locals.session
3. If no session, redirect to /auth/login
4. Return { user: session.user }

Create `src/routes/dashboard/+layout.svelte`:
1. Import data from $page.data
2. Create navigation sidebar/header:
   - Link to /dashboard (Overview)
   - Link to /dashboard/billing (Billing - this phase)
   - Link to /dashboard/logs (Logs - Phase 5)
   - User profile display with email
   - Logout button (calls authClient.signOut())
3. Slot for page content: `<slot />`
4. Styling with Tailwind:
   - Responsive layout (sidebar on desktop, hamburger on mobile)
   - Clean, minimal design
   - Active link highlighting

Follow SvelteKit layout pattern. Dashboard is authentication-gated at layout level.
  </action>
  <verify>
Verify TypeScript compilation:
```bash
cd /tmp/rachel-cloud && bun run check
```

Verify auth client exports:
```bash
cd /tmp/rachel-cloud && bun -e "
const module = await import('./src/lib/auth/client.ts');
console.log('Auth client exported:', !!module.authClient);
console.log('✓ Auth client available');
"
```

Verify dashboard layout requires auth (redirects if not logged in):
```bash
cd /tmp/rachel-cloud && grep -q "redirect" src/routes/dashboard/+layout.server.ts && echo "✓ Dashboard protected by auth"
```
  </verify>
  <done>
Better Auth client initialized for frontend use. Dashboard layout created with navigation and authentication protection. Layout redirects unauthenticated users to login page. Navigation includes billing section.
  </done>
</task>

<task type="auto">
  <name>Task 2: Build billing dashboard with subscription status and management</name>
  <files>
    src/routes/dashboard/billing/+page.server.ts
    src/routes/dashboard/billing/+page.svelte
  </files>
  <action>
Create `src/routes/dashboard/billing/+page.server.ts`:
1. Import db, subscriptions from '$lib/db'
2. Import eq from 'drizzle-orm'
3. Import authClient from '$lib/auth/client' (server-side instance if needed, or use polarClient directly)
4. Implement load function:
   - Get session from event.locals.session
   - If no session, throw redirect to /auth/login (redundant with layout but defensive)
   - Query subscription from database using userId
   - If subscription exists and has polarCustomerId, optionally fetch latest state from Polar API:
     - Use polarClient.customers.subscriptions.list({ customerId })
     - Get most recent subscription details (for real-time status)
   - Return: { subscription, hasActiveSubscription: subscription?.status === 'active' }

Create `src/routes/dashboard/billing/+page.svelte`:
1. Import data from $page.data
2. Import { authClient } from '$lib/auth/client'
3. State management:
   - canceling: boolean (loading state for cancel action)
   - showCancelConfirm: boolean (modal/confirm dialog)
   - error: string | null

4. Subscription status display:
   - Card showing current status badge (active = green, grace_period = yellow, canceled = gray)
   - If active:
     - Show "Active Subscription"
     - Display next billing date: format(data.subscription.currentPeriodEnd, 'MMM d, yyyy')
     - Show amount: "$20/month"
   - If grace_period:
     - Show "Grace Period" warning
     - Display "Your subscription was canceled. VPS will be deprovisioned on {gracePeriodEndsAt}"
     - CTA: "Reactivate Subscription" → opens customer portal
   - If canceled:
     - Show "No Active Subscription"
     - CTA: "Subscribe" → redirects to /onboarding

5. Payment method management:
   - "Manage Payment Method" button
   - On click: Call `authClient.customer.portal()` to redirect to Polar customer portal
   - Per RESEARCH.md Code Examples: Customer Portal Redirect

6. Cancellation flow:
   - "Cancel Subscription" button (only show if active)
   - On click: Show confirmation dialog/modal
   - Confirmation text: "Are you sure? Your VPS will be deprovisioned after 3 days."
   - Confirm button: "Yes, Cancel Subscription"
   - On confirm:
     - Set canceling = true
     - POST to /api/billing/cancel
     - On success: Reload page data or update UI to show grace_period
     - On error: Display error message
     - Set canceling = false

7. Styling:
   - Tailwind card components
   - Status badges with color coding
   - Clear button hierarchy (primary, secondary, danger for cancel)
   - Responsive layout

Follow BILL-02 and BILL-03 requirements. Use RESEARCH.md Customer Portal Redirect pattern.
  </action>
  <verify>
Verify TypeScript compilation:
```bash
cd /tmp/rachel-cloud && bun run check
```

Verify billing page loads (will need auth):
```bash
cd /tmp/rachel-cloud && ls src/routes/dashboard/billing/+page.svelte && echo "✓ Billing dashboard page created"
```

Verify page uses authClient.customer.portal:
```bash
cd /tmp/rachel-cloud && grep -q "customer.portal" src/routes/dashboard/billing/+page.svelte && echo "✓ Customer portal integration present"
```
  </verify>
  <done>
Billing dashboard displays subscription status with color-coded badges. Next billing date shown for active subscriptions. Users can open Polar customer portal to update payment methods. Cancellation flow includes confirmation and triggers grace period. Error handling and loading states provide good UX.
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <what-built>
Complete billing dashboard with subscription management, Polar customer portal integration, and cancellation flow. Multi-step onboarding UI with Telegram bot validation. Webhook handlers for subscription lifecycle events.
  </what-built>
  <how-to-verify>
**Prerequisites:** Set up environment variables (.env):
- POLAR_ACCESS_TOKEN (from Polar dashboard)
- POLAR_PRODUCT_ID (create $20/month product in Polar)
- POLAR_WEBHOOK_SECRET (from Polar webhook settings)
- POLAR_MODE=sandbox
- RESEND_API_KEY (from Resend dashboard)
- RESEND_FROM_EMAIL (verified email)
- GOOGLE_CLIENT_ID, GOOGLE_CLIENT_SECRET (from Phase 1)
- ENCRYPTION_KEY (from Phase 1)

**Testing steps:**

1. **Start dev server:**
   ```bash
   cd /tmp/rachel-cloud && bun run dev
   ```

2. **Test onboarding flow:**
   - Navigate to http://localhost:5173/onboarding
   - Verify payment step shows "Subscribe to Rachel Cloud" with $20/month
   - Click "Subscribe Now" → should redirect to Polar checkout (sandbox mode)
   - Complete payment (use Polar sandbox test card)
   - Verify redirect back to /onboarding?checkout_id={CHECKOUT_ID}
   - Verify Telegram bot step appears
   - Read BotFather instructions - are they clear and actionable?
   - Create a test Telegram bot via @BotFather
   - Paste bot token into form
   - Verify validation succeeds and bot username displays
   - Verify provisioning step appears (placeholder for Phase 3)

3. **Test billing dashboard:**
   - Navigate to http://localhost:5173/dashboard/billing
   - Verify subscription status shows "Active"
   - Verify next billing date is displayed correctly
   - Verify "$20/month" amount is shown
   - Click "Manage Payment Method" → should redirect to Polar customer portal
   - Return to dashboard
   - Click "Cancel Subscription" → verify confirmation dialog appears
   - Confirm cancellation → verify status changes to "Grace Period"
   - Verify grace period end date is shown (3 days from now)

4. **Test webhook handling (manual trigger):**
   - Use Polar dashboard to manually trigger webhook events
   - Or use Polar CLI: `polar webhooks trigger subscription.canceled`
   - Check application logs for webhook processing
   - Verify subscription status updates in database
   - Verify grace period jobs are scheduled (check logs)

5. **Test email notifications:**
   - Trigger payment.failed webhook from Polar dashboard
   - Check Resend dashboard for sent email
   - Verify email received at user's email address
   - Verify email content includes payment failed message and link to billing dashboard

**Expected results:**
- ✅ Onboarding completes in under 5 minutes
- ✅ BotFather instructions are clear without prior knowledge
- ✅ Telegram token validation provides immediate feedback
- ✅ Billing dashboard shows accurate subscription status
- ✅ Customer portal redirect works
- ✅ Cancellation triggers grace period (3 days)
- ✅ Payment failed email sends successfully
- ✅ Webhooks update database state correctly

**Report any issues:**
- Broken links or redirects
- Unclear instructions
- Validation errors
- Missing data displays
- Email delivery failures
- Webhook processing errors
  </how-to-verify>
  <resume-signal>
Type "approved" if all verification steps pass, or describe any issues found that need fixing.
  </resume-signal>
</task>

</tasks>

<verification>
1. Run `bun run check` and verify TypeScript compilation with no errors
2. Verify auth client exports authClient for frontend use
3. Verify dashboard layout protects routes with authentication
4. Verify billing page loads subscription data from database
5. Verify billing page shows status, next billing date, cancel button
6. Verify customer portal redirect uses authClient.customer.portal()
7. Test full flow: signup → subscribe → enter bot token → view billing dashboard
</verification>

<success_criteria>
1. User can view subscription status with color-coded badges (active/grace_period/canceled)
2. Next billing date displays correctly for active subscriptions (BILL-02)
3. User can cancel subscription with confirmation dialog (BILL-03)
4. Canceled subscriptions show grace period countdown (3 days)
5. "Manage Payment Method" button redirects to Polar customer portal
6. Dashboard is protected by authentication and redirects unauthenticated users
7. Onboarding flow completes successfully from payment to bot validation
8. Average onboarding time is under 5 minutes (ONBR-04)
</success_criteria>

<output>
After completion, create `.planning/phases/02-billing-onboarding/02-04-SUMMARY.md` using the summary template.
</output>
